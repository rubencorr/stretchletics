<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Stretchletics</title>
    <link rel="icon" type="image/png" href="/media/logo_round.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "neon-pink": "#EC4899",
              "neon-indigo": "#4F46E5",
              "deep-black": "#050505",
              "dark-charcoal": "#10141D",
              "deep-navy": "#1D2A4A",
            },
            boxShadow: {
              // Custom shadows are still defined, but the animation uses standard CSS
              "neon-pink":
                '0 0 20px theme("colors.neon-pink"), 0 0 60px theme("colors.neon-pink")',
              "neon-indigo":
                '0 0 20px theme("colors.neon-indigo"), 0 0 60px theme("colors.neon-indigo")',
              glass: "0 8px 32px 0 rgba(0, 0, 0, 0.37)",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap");
      :root {
        font-family: "Inter", sans-serif;
      }
      /* Enhanced Animated Background */
      body {
        position: relative;
        overflow-x: hidden;
      }

      /* Animated Gradient Overlay */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(79, 70, 229, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(236, 72, 153, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(99, 102, 241, 0.1) 0%,
            transparent 60%
          );
        animation: gradient-shift 15s ease infinite;
        z-index: 0;
        pointer-events: none;
      }

      /* Enhanced Moving Grid */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(
            circle,
            rgba(79, 70, 229, 0.03) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(236, 72, 153, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        background-position: 0 0, 25px 25px;
        z-index: 0;
        pointer-events: none;
        animation: grid-float 20s linear infinite;
      }

      @keyframes gradient-shift {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
        33% {
          transform: translate(10%, -10%) scale(1.1);
          opacity: 0.8;
        }
        66% {
          transform: translate(-10%, 10%) scale(0.9);
          opacity: 0.9;
        }
      }

      @keyframes grid-float {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(50px, 50px);
        }
      }

      /* Floating Orbs */
      .bg-orb {
        position: fixed;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.5;
        animation: float-orb 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
      }

      .bg-orb-1 {
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle,
          rgba(236, 72, 153, 0.4),
          transparent
        );
        top: -50px;
        left: -100px;
        animation-delay: 0s;
      }

      .bg-orb-2 {
        width: 250px;
        height: 250px;
        background: radial-gradient(
          circle,
          rgba(79, 70, 229, 0.4),
          transparent
        );
        bottom: -50px;
        right: -80px;
        animation-delay: 5s;
      }

      .bg-orb-3 {
        width: 200px;
        height: 200px;
        background: radial-gradient(
          circle,
          rgba(167, 139, 250, 0.3),
          transparent
        );
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation-delay: 10s;
      }

      @keyframes float-orb {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        25% {
          transform: translate(20px, -30px) scale(1.1);
        }
        50% {
          transform: translate(-20px, 30px) scale(0.9);
        }
        75% {
          transform: translate(30px, 20px) scale(1.05);
        }
      }

      /* Ensure content is above background */
      body > div {
        position: relative;
        z-index: 1;
      }

      /* ---------------------------------- */
      /* --- 1. Neon Glow Keyframes CSS --- */
      /* ---------------------------------- */

      /* ---------------------------------- */
      /* --- 2. Element Styling --- */
      /* ---------------------------------- */

      /* Enhanced Glassmorphism Card */
      .glass-card {
        background: rgba(10, 10, 10, 0.75);
        backdrop-filter: blur(32px) saturate(200%);
        -webkit-backdrop-filter: blur(32px) saturate(200%);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
          0 0 80px rgba(79, 70, 229, 0.05);
        transition: all 0.5s ease-in-out;
      }

      /* Gradient Button Effect - Sleek Neon Plasma */
      .gradient-button {
        background-image: linear-gradient(
          to right,
          #4f46e5 0%,
          #ec4899 51%,
          #4f46e5 100%
        );
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        background-size: 200% auto;
        color: white;
        border-radius: 8px;
        display: inline-block;
        position: relative;
        z-index: 1;
        box-shadow: 0 0 8px rgba(79, 70, 229, 0.3); /* Base glow */
      }
      .gradient-button:hover {
        background-position: right center;
        transform: translateY(-2px);
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.4),
          0 0 25px rgba(79, 70, 229, 0.3);
      }

      /* Custom scrollbar for chat area */
      .chat-area::-webkit-scrollbar {
        width: 8px;
      }
      .chat-area::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      .chat-area::-webkit-scrollbar-thumb {
        background: rgba(236, 72, 153, 0.4);
        border-radius: 10px;
      }
      .chat-area::-webkit-scrollbar-thumb:hover {
        background: rgba(79, 70, 229, 0.6);
      }

      /* Custom scrollbar for parameters sidebar */
      .params-sidebar::-webkit-scrollbar {
        width: 6px;
      }
      .params-sidebar::-webkit-scrollbar-track {
        background: rgba(236, 72, 153, 0.05);
        border-radius: 10px;
      }
      .params-sidebar::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #ec4899, #4f46e5);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .params-sidebar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #f472b6, #6366f1);
        box-shadow: 0 0 8px rgba(236, 72, 153, 0.4);
      }

      /* Custom scrollbar for parameters sidebar */
      .params-sidebar::-webkit-scrollbar {
        width: 6px;
      }
      .params-sidebar::-webkit-scrollbar-track {
        background: rgba(236, 72, 153, 0.05);
        border-radius: 10px;
      }
      .params-sidebar::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #ec4899, #4f46e5);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .params-sidebar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #f472b6, #6366f1);
        box-shadow: 0 0 8px rgba(236, 72, 153, 0.4);
      }

      /* Hide scrollbar for quick examples */
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* User Message Bubble Style */
      .user-message-bubble {
        background: rgba(236, 72, 153, 0.15);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-radius: 1rem 1rem 0.2rem 1rem;
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(236, 72, 153, 0.2);
      }

      /* Bot Message Bubble Style */
      .bot-message-bubble {
        background: #1d2a4a; /* deep-navy */
        border: 1px solid rgba(79, 70, 229, 0.3);
        border-radius: 1rem 1rem 1rem 0.2rem;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2);
      }

      /* Custom Checkbox Styling */
      input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
      }
      input[type="checkbox"]:hover {
        border-color: rgba(236, 72, 153, 0.6);
        box-shadow: 0 0 8px rgba(236, 72, 153, 0.3);
      }
      input[type="checkbox"]:checked {
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        border-color: #ec4899;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.4);
      }
      input[type="checkbox"]:checked::after {
        content: "âœ“";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      /* Range Slider Styling */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #ec4899 0%, #4f46e5 100%);
        outline: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        cursor: pointer;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.6);
        transition: all 0.2s ease;
      }
      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
      }
      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        cursor: pointer;
        border: none;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.6);
        transition: all 0.2s ease;
      }
      input[type="range"]::-moz-range-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
      }

      /* Typing Indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4f46e5;
        animation: typing-bounce 1.4s infinite;
        display: inline-block;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typing-bounce {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.7;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      /* Action Buttons */
      .action-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 12px;
      }
      .action-btn:hover {
        background: rgba(236, 72, 153, 0.2);
        border-color: rgba(236, 72, 153, 0.5);
        transform: translateY(-1px);
      }
      .action-btn.success {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.5);
      }

      /* History Sidebar */
      .history-sidebar {
        position: fixed;
        left: -320px;
        top: 0;
        width: 320px;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(32px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        transition: left 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
      }
      .history-sidebar.open {
        left: 0;
      }
      .history-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .history-item:hover {
        background: rgba(79, 70, 229, 0.15);
        border-color: rgba(79, 70, 229, 0.3);
        transform: translateX(4px);
      }
      .burger-menu {
        position: fixed;
        top: 16px;
        left: 20px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .burger-menu:hover {
        transform: scale(1.1);
        color: #ec4899;
      }

      /* Example chip styling */
      .example-chip {
        background: rgba(236, 72, 153, 0.1);
        border: 1px solid rgba(236, 72, 153, 0.3);
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .example-chip:hover {
        background: rgba(236, 72, 153, 0.2);
        border-color: rgba(236, 72, 153, 0.6);
        transform: scale(1.05);
      }

      /* Select dropdown styling */
      select {
        background-color: rgba(0, 0, 0, 0.3) !important;
        color: white !important;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ec4899' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
      }

      select:hover {
        background-color: rgba(236, 72, 153, 0.1) !important;
        border-color: rgba(236, 72, 153, 0.3) !important;
      }

      select option {
        background-color: #1a1a1a !important;
        color: white !important;
        padding: 8px;
      }

      select option:checked {
        background-color: #4f46e5 !important;
        color: white !important;
      }

      /* Quick Action Chips */
      .example-chip {
        background: rgba(79, 70, 229, 0.2);
        border: 1px solid rgba(79, 70, 229, 0.3);
        transition: all 0.2s ease;
      }
      .example-chip:hover {
        background: rgba(236, 72, 153, 0.3);
        border-color: rgba(236, 72, 153, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
      }

      /* Routine Card Styling */
      .routine-card {
        background: rgba(79, 70, 229, 0.1);
        border: 1px solid rgba(79, 70, 229, 0.3);
        border-radius: 12px;
        margin-top: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .routine-card:hover {
        border-color: rgba(236, 72, 153, 0.4);
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
      }
      .routine-header {
        cursor: pointer;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.3);
        transition: background 0.2s ease;
      }
      .routine-header:hover {
        background: rgba(0, 0, 0, 0.5);
      }
      .routine-content {
        padding: 16px;
        display: none;
      }
      .routine-content.expanded {
        display: block;
      }

      /* Timestamp styling */
      .message-timestamp {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 4px;
      }

      /* Voice input button */
      .voice-btn {
        background: rgba(236, 72, 153, 0.2);
        border: 1px solid rgba(236, 72, 153, 0.3);
        transition: all 0.2s ease;
      }
      .voice-btn:hover {
        background: rgba(236, 72, 153, 0.3);
        border-color: rgba(236, 72, 153, 0.5);
        transform: scale(1.05);
      }
      .voice-btn.listening {
        background: rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      /* Message animations */
      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .message-animate {
        animation: messageSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* Exercise card styling */
      .exercise-card {
        background: rgba(79, 70, 229, 0.08);
        border: 1px solid rgba(79, 70, 229, 0.2);
        border-radius: 10px;
        padding: 14px;
        margin: 10px 0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }
      .exercise-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(to bottom, #ec4899, #4f46e5);
      }
      .exercise-card:hover {
        background: rgba(79, 70, 229, 0.15);
        border-color: rgba(236, 72, 153, 0.4);
        transform: translateX(4px);
      }
      .exercise-card.expanded {
        background: rgba(79, 70, 229, 0.18);
        border-color: rgba(236, 72, 153, 0.5);
      }
      .exercise-explanation {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease,
          margin-top 0.3s ease;
        opacity: 0;
      }
      .exercise-explanation.expanded {
        max-height: 300px;
        opacity: 1;
        margin-top: 12px;
      }
      .exercise-chevron {
        transition: transform 0.3s ease;
        color: #ec4899;
        font-size: 14px;
      }
      .exercise-chevron.rotated {
        transform: rotate(180deg);
      }

      /* Timer styling */
      .timer-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(236, 72, 153, 0.2);
      }
      .timer-display {
        font-size: 24px;
        font-weight: 900;
        font-family: "Courier New", monospace;
        color: #ec4899;
        min-width: 80px;
        text-align: center;
      }
      .timer-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid rgba(236, 72, 153, 0.5);
        background: rgba(236, 72, 153, 0.2);
        color: #f472b6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
      }
      .timer-btn:hover {
        background: rgba(236, 72, 153, 0.4);
        border-color: rgba(236, 72, 153, 0.8);
        transform: scale(1.1);
      }
      .timer-btn.active {
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        border-color: #ec4899;
        animation: pulse 1.5s infinite;
      }
      .timer-progress-bar {
        flex-grow: 1;
        height: 8px;
        background: rgba(79, 70, 229, 0.2);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }
      .timer-progress-fill {
        height: 100%;
        background: linear-gradient(to right, #ec4899, #4f46e5);
        transition: width 0.3s linear;
        border-radius: 4px;
      }
      .exercise-card.timer-active {
        border-color: #ec4899;
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
        animation: timerPulse 2s infinite;
      }
      @keyframes timerPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(236, 72, 153, 0.5);
        }
      }
      .timer-complete {
        animation: timerComplete 0.5s ease;
      }
      @keyframes timerComplete {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Global routine timer */
      .routine-timer {
        background: linear-gradient(
          135deg,
          rgba(79, 70, 229, 0.2),
          rgba(236, 72, 153, 0.2)
        );
        border: 2px solid rgba(236, 72, 153, 0.4);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }
      .routine-timer.running {
        border-color: #ec4899;
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.4);
        animation: timerPulse 2s infinite;
      }
      .global-timer-display {
        font-size: 36px;
        font-weight: 900;
        font-family: "Courier New", monospace;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        min-width: 120px;
        text-align: center;
      }
      .global-timer-info {
        flex-grow: 1;
      }
      .current-exercise-name {
        font-size: 16px;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
      }
      .routine-progress-text {
        font-size: 12px;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .global-timer-controls {
        display: flex;
        gap: 8px;
      }
      .exercise-card.active {
        background: rgba(236, 72, 153, 0.2);
        border-color: #ec4899;
        border-width: 2px;
        transform: translateX(8px);
        box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
      }
      .exercise-card.completed {
        opacity: 0.6;
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
      }
      .exercise-card.completed .exercise-number {
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }

      .exercise-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        color: white;
        font-weight: 900;
        font-size: 13px;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .exercise-duration {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        background: rgba(236, 72, 153, 0.2);
        border: 1px solid rgba(236, 72, 153, 0.3);
        font-size: 11px;
        font-weight: 700;
        color: #f472b6;
      }

      /* Quick action buttons */
      .quick-action-btn {
        background: rgba(236, 72, 153, 0.1);
        border: 1px solid rgba(236, 72, 153, 0.25);
        padding: 8px 14px;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        color: #f472b6;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .quick-action-btn:hover {
        background: rgba(236, 72, 153, 0.25);
        border-color: rgba(236, 72, 153, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
      }

      /* Parameter notification */
      .param-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(34, 197, 94, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(34, 197, 94, 0.5);
        padding: 12px 18px;
        border-radius: 10px;
        color: white;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1002;
        box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        animation: notificationSlide 0.4s ease, notificationFade 3s ease;
      }
      @keyframes notificationSlide {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes notificationFade {
        0%,
        85% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* Enhanced loading states */
      .loading-progress {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .loading-bar {
        height: 3px;
        background: rgba(79, 70, 229, 0.2);
        border-radius: 2px;
        overflow: hidden;
        position: relative;
      }
      .loading-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 40%;
        background: linear-gradient(to right, #ec4899, #4f46e5);
        animation: loadingSlide 1.5s ease-in-out infinite;
      }
      @keyframes loadingSlide {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(350%);
        }
      }
      .loading-text {
        font-size: 12px;
        color: #a78bfa;
        font-weight: 600;
      }

      /* Sticky parameter header */
      .param-header-sticky {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(20px);
        padding: 16px;
        margin: -20px -20px 20px -20px;
        border-bottom: 1px solid rgba(236, 72, 153, 0.2);
      }

      /* Collapsible section */
      .collapsible-section {
        margin-bottom: 16px;
      }
      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 10px 12px;
        background: rgba(236, 72, 153, 0.08);
        border: 1px solid rgba(236, 72, 153, 0.2);
        border-radius: 8px;
        transition: all 0.2s ease;
      }
      .collapsible-header:hover {
        background: rgba(236, 72, 153, 0.15);
        border-color: rgba(236, 72, 153, 0.35);
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .collapsible-content.expanded {
        max-height: 500px;
        padding-top: 12px;
      }
      .collapsible-icon {
        transition: transform 0.3s ease;
      }
      .collapsible-icon.rotated {
        transform: rotate(180deg);
      }

      /* Active filter badges */
      .filter-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(236, 72, 153, 0.25);
        border: 1px solid rgba(236, 72, 153, 0.4);
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        color: #f9a8d4;
        margin: 2px;
      }

      /* Routine summary card */
      .routine-summary {
        background: linear-gradient(
          135deg,
          rgba(79, 70, 229, 0.15),
          rgba(236, 72, 153, 0.15)
        );
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .routine-summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .routine-summary-value {
        font-size: 24px;
        font-weight: 900;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .routine-summary-label {
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 600;
        color: #94a3b8;
        letter-spacing: 0.5px;
      }
    </style>
  </head>

  <body
    class="bg-[#050505] text-slate-300 antialiased h-screen overflow-hidden"
  >
    <!-- Floating background orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Burger Menu -->
    <button id="burger-menu" class="burger-menu">
      <i class="fa-solid fa-bars text-white text-lg"></i>
    </button>

    <!-- History Sidebar -->
    <div id="history-sidebar" class="history-sidebar">
      <div class="p-6 pl-16">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-black text-white uppercase tracking-wider">
            History
          </h2>
          <button
            id="close-history"
            class="text-slate-400 hover:text-white transition"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>
        <div id="history-list" class="space-y-3">
          <p class="text-sm text-slate-500 italic text-center py-8">
            No chat history yet
          </p>
        </div>
        <button
          id="clear-history"
          class="w-full mt-6 px-4 py-2 bg-red-500/20 border border-red-500/30 rounded-lg text-red-400 text-sm font-bold hover:bg-red-500/30 transition"
        >
          <i class="fa-solid fa-trash mr-2"></i>Clear All History
        </button>
      </div>
    </div>

    <div class="w-full h-full flex flex-col">
      <!-- Header moved to top-left -->
      <div class="flex items-center justify-between py-4 px-6 pl-20">
        <h1 class="text-2xl font-black tracking-wider text-white uppercase">
          <i class="fa-solid fa-sparkles text-neon-pink mr-2"></i>Stretchletics
        </h1>
      </div>

      <!-- Unified Single Window -->
      <div class="overflow-hidden flex-grow flex h-full">
        <!-- LEFT SIDEBAR: PARAMETERS -->
        <div
          class="params-sidebar w-64 overflow-y-auto px-6 py-5"
          style="
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
          "
        >
          <!-- Sticky Header -->
          <div class="param-header-sticky">
            <h2
              class="text-base font-black text-white uppercase tracking-wider flex items-center gap-2"
            >
              <i class="fa-solid fa-sliders text-neon-pink"></i>
              Parameters
            </h2>
          </div>

          <!-- Routine Type -->
          <div class="mb-5 mt-10">
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"
            >
              Routine Type
            </label>
            <select
              id="routine-type-input"
              onchange="updateActiveFilters()"
              class="w-full p-2.5 rounded-lg border border-white/10 bg-white/5 text-white text-sm focus:ring-2 focus:ring-neon-pink focus:border-transparent transition duration-300 outline-none"
            >
              <option value="warm-up">Warm-Up</option>
              <option value="cool-down" selected>Stretching</option>
            </select>
          </div>

          <!-- Duration -->
          <div class="mb-5">
            <div class="flex justify-between items-center mb-2">
              <label
                class="block text-xs font-bold text-slate-400 uppercase tracking-wider"
              >
                Duration
              </label>
              <span
                id="duration-display"
                class="text-sm text-neon-pink font-bold"
                >5 min</span
              >
            </div>
            <input
              type="range"
              id="duration-input"
              min="5"
              max="60"
              value="5"
              step="5"
              oninput="updateDurationDisplay(); updateActiveFilters();"
              class="w-full"
            />
          </div>

          <!-- Difficulty Level -->
          <div class="mb-5">
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"
            >
              Difficulty
            </label>
            <select
              id="difficulty-input"
              onchange="updateActiveFilters()"
              class="w-full p-2.5 rounded-lg border border-white/10 bg-white/5 text-white text-sm focus:ring-2 focus:ring-neon-pink focus:border-transparent transition duration-300 outline-none"
            >
              <option value="beginner" selected>Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>

          <!-- Equipment Available -->
          <div class="mb-5">
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
            >
              Equipment
            </label>
            <div class="space-y-2.5">
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="equipment-roller"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Foam Roller</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="equipment-bands"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Resistance Bands</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="equipment-mat"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Yoga Mat</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="equipment-ball"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Stability Ball</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="equipment-massage"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Massage Ball</span>
              </label>
            </div>
          </div>

          <!-- Focus Areas -->
          <div class="mb-5">
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
            >
              Focus Areas
            </label>
            <div class="space-y-2.5">
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="focus-upper"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Upper Body</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="focus-lower"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Lower Body</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="focus-core"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Core</span>
              </label>
              <label
                class="flex items-center cursor-pointer hover:text-white transition"
              >
                <input
                  type="checkbox"
                  id="focus-full"
                  onchange="updateActiveFilters()"
                  class="w-4 h-4 rounded"
                />
                <span class="ml-2.5 text-sm">Full Body</span>
              </label>
            </div>
          </div>

          <!-- Injuries/Restrictions -->
          <div class="mb-5">
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"
            >
              Restrictions
            </label>
            <textarea
              id="restrictions-input"
              placeholder="Any injuries or restrictions..."
              class="w-full p-2.5 rounded-lg border border-white/10 bg-white/5 text-white placeholder-slate-500 text-sm focus:ring-2 focus:ring-neon-pink focus:border-transparent transition duration-300 outline-none resize-none"
              rows="3"
            ></textarea>
          </div>
        </div>

        <!-- RIGHT SIDE: CHAT -->
        <div
          class="flex-grow flex flex-col overflow-hidden"
          style="background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px)"
        >
          <div
            id="chat-messages"
            class="chat-area p-6 space-y-6 overflow-y-auto flex-1"
          >
            <!-- Welcome Message -->
            <div class="flex justify-start">
              <div class="bot-message-bubble p-4 max-w-2xl">
                <p
                  class="font-bold text-neon-indigo uppercase text-xs tracking-wider"
                >
                  <i class="fa-solid fa-sparkles mr-1"></i> Stretchletics
                </p>
                <p class="mt-1.5 text-sm leading-snug">
                  Welcome! I'll create personalized stretching routines based on
                  your workouts and goals.
                </p>
                <div class="mt-3 pt-3 border-t border-white/10">
                  <p
                    class="text-xs text-slate-400 mb-2 font-bold uppercase tracking-wider"
                  >
                    Quick Examples:
                  </p>
                  <div class="flex gap-2 overflow-x-auto scrollbar-hide">
                    <button
                      class="example-chip px-3 py-1.5 rounded-full text-xs font-medium text-white whitespace-nowrap flex-shrink-0"
                    >
                      <i class="fa-solid fa-person-running mr-1"></i> Post-run
                      cooldown
                    </button>
                    <button
                      class="example-chip px-3 py-1.5 rounded-full text-xs font-medium text-white whitespace-nowrap flex-shrink-0"
                    >
                      <i class="fa-solid fa-dumbbell mr-1"></i> Upper body
                      stretch
                    </button>
                    <button
                      class="example-chip px-3 py-1.5 rounded-full text-xs font-medium text-white whitespace-nowrap flex-shrink-0"
                    >
                      <i class="fa-solid fa-bed mr-1"></i> Morning mobility
                    </button>
                    <button
                      class="example-chip px-3 py-1.5 rounded-full text-xs font-medium text-white whitespace-nowrap flex-shrink-0"
                    >
                      <i class="fa-solid fa-briefcase mr-1"></i> Desk worker
                      relief
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="pt-2 pb-4 px-4 border-t border-white/5 bg-black/20">
            <div class="flex items-center space-x-3 mb-4">
              <button
                id="last-workout-btn"
                class="gradient-button flex-shrink-0 px-4 py-3 text-sm font-bold tracking-wider"
              >
                <i class="fa-solid fa-rotate inline-block mr-2"></i>
                Sync Last Workout
              </button>
              <div
                id="last-workout-status"
                class="text-xs text-slate-500 italic flex-grow truncate"
              >
                (Ready to sync)
              </div>
            </div>

            <form id="chat-form" class="flex space-x-2">
              <input
                type="text"
                id="chat-input"
                required
                placeholder="Ask me for a routine..."
                class="flex-grow h-12 px-4 rounded-lg border border-white/10 bg-white/5 text-white placeholder-slate-500 focus:ring-2 focus:ring-neon-pink focus:border-transparent transition duration-300 outline-none shadow-inner"
              />
              <button
                type="button"
                id="voice-button"
                class="voice-btn flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center"
                title="Voice input"
              >
                <i class="fa-solid fa-microphone"></i>
              </button>
              <button
                type="submit"
                id="send-button"
                class="gradient-button flex-shrink-0 w-12 h-12 text-base font-bold flex items-center justify-center"
              >
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const chatMessages = document.getElementById("chat-messages");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");
      const lastWorkoutBtn = document.getElementById("last-workout-btn");
      const lastWorkoutStatus = document.getElementById("last-workout-status");

      // Parameter inputs
      const routineTypeInput = document.getElementById("routine-type-input");
      const durationInput = document.getElementById("duration-input");
      const difficultyInput = document.getElementById("difficulty-input");
      const restrictionsInput = document.getElementById("restrictions-input");

      // --- Mock Data ---
      const mockLastWorkout = {
        type: "Running",
        duration: "1 hour 15 minutes",
        intensity: "Moderate",
        muscleGroupsUsed: [
          "Quadriceps",
          "Hamstrings",
          "Glutes",
          "Calves",
          "Core",
        ],
        date: new Date().toLocaleDateString(),
        distance: "12 km",
      };

      // --- Helper Functions ---

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      let lastUserPrompt = "";
      let lastRoutineData = null;

      function addMessage(text, sender = "bot", isRoutine = false) {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = "message-animate";
        const messageBox = document.createElement("div");
        const timestamp = new Date().toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (sender === "user") {
          lastUserPrompt = text;
          messageWrapper.className = "flex justify-end";
          messageBox.className = "p-3 max-w-xs sm:max-w-md user-message-bubble";
          const textEl = document.createElement("p");
          textEl.className = "text-sm";
          textEl.textContent = text;
          const timeEl = document.createElement("div");
          timeEl.className = "message-timestamp text-right";
          timeEl.textContent = timestamp;
          messageBox.appendChild(textEl);
          messageBox.appendChild(timeEl);
        } else {
          messageWrapper.className = "flex justify-start";
          messageBox.className = "p-4 w-full max-w-4xl bot-message-bubble";

          const senderTag = document.createElement("p");
          senderTag.className =
            "font-bold uppercase text-xs tracking-wider " +
            (isRoutine ? "text-neon-pink" : "text-neon-indigo");
          senderTag.innerHTML = isRoutine
            ? '<i class="fa-solid fa-fire mr-1"></i> Stretchletics'
            : '<i class="fa-solid fa-robot mr-1"></i> Stretchletics';

          const messageContent = document.createElement("div");
          messageContent.className = "mt-2";

          if (isRoutine) {
            // Parse and format routine
            const exercises = parseRoutine(text);
            lastRoutineData = { text, exercises };

            // If parsing found exercises, show cards
            if (
              exercises.length > 0 &&
              exercises[0].name !== "View Full Routine Below"
            ) {
              // Create combined timer and summary box
              const routineTimerId = `routine-${Date.now()}`;
              const globalTimer = document.createElement("div");
              globalTimer.className = "routine-timer";
              globalTimer.id = routineTimerId;
              globalTimer.innerHTML = `
                <div style="display: flex; align-items: center; gap: 16px; width: 100%; margin-bottom: 12px;">
                  <div class="global-timer-display" id="display-${routineTimerId}">0:00</div>
                  <div class="global-timer-info" style="flex-grow: 1;">
                    <div class="current-exercise-name" id="current-${routineTimerId}">Ready to start</div>
                    <div class="routine-progress-text" id="progress-text-${routineTimerId}">Exercise 0 of ${
                exercises.length
              }</div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 0 12px;">
                    <div class="routine-summary-stat">
                      <div class="routine-summary-value" style="font-size: 20px;">${
                        exercises.length
                      }</div>
                      <div class="routine-summary-label" style="font-size: 9px;">Exercises</div>
                    </div>
                    <div class="routine-summary-stat">
                      <div class="routine-summary-value" style="font-size: 20px;">${calculateTotalDuration(
                        exercises
                      )}</div>
                      <div class="routine-summary-label" style="font-size: 9px;">Minutes</div>
                    </div>
                    <div class="routine-summary-stat">
                      <div class="routine-summary-value" style="font-size: 20px;">${
                        document.getElementById("difficulty-input").value
                      }</div>
                      <div class="routine-summary-label" style="font-size: 9px;">Level</div>
                    </div>
                  </div>
                  <div class="global-timer-controls">
                    <button class="timer-btn" id="toggle-${routineTimerId}" onclick="toggleRoutineTimer('${routineTimerId}')" title="Start routine">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <button class="timer-btn" onclick="skipExercise('${routineTimerId}')" title="Skip exercise">
                      <i class="fa-solid fa-forward-step"></i>
                    </button>
                    <button class="timer-btn" onclick="resetRoutineTimer('${routineTimerId}')" title="Reset routine">
                      <i class="fa-solid fa-rotate-left"></i>
                    </button>
                  </div>
                </div>
                <div class="timer-progress-bar" style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; border-radius: 0 0 10px 10px;">
                  <div class="timer-progress-fill" id="routine-progress-${routineTimerId}" style="width: 0%"></div>
                </div>
              `;
              messageContent.appendChild(globalTimer);

              // Create exercise cards
              const exercisesContainer = document.createElement("div");
              exercisesContainer.className = "space-y-2 mb-4";
              exercises.forEach((exercise, index) => {
                const card = document.createElement("div");
                card.className = "exercise-card";
                const exerciseId = `exercise-${Date.now()}-${index}`;
                const durationSeconds = parseDurationToSeconds(
                  exercise.duration
                );

                card.setAttribute("data-exercise-id", exerciseId);
                card.setAttribute("data-duration", durationSeconds);
                card.innerHTML = `
                  <div class="flex items-center gap-3">
                    <span class="exercise-number">${index + 1}</span>
                    <div class="flex-grow">
                      <h4 class="text-white font-bold text-sm">${
                        exercise.name
                      }</h4>
                    </div>
                    <span class="exercise-duration mr-2">
                      ${exercise.duration}
                    </span>
                    <i class="fa-solid fa-chevron-down exercise-chevron"></i>
                  </div>
                  <div class="exercise-explanation" data-explanation="${exerciseId}">
                    <div class="pl-11 pr-2 text-xs text-slate-300 leading-relaxed">
                      <p class="mb-2"><strong class="text-neon-pink">How to perform:</strong></p>
                      <p>${
                        exercise.explanation ||
                        "Click the exercise name for detailed instructions on proper form and technique."
                      }</p>
                    </div>
                  </div>
                `;

                // Add click handler
                card.addEventListener("click", function (e) {
                  this.classList.toggle("expanded");
                  const explanation = this.querySelector(
                    ".exercise-explanation"
                  );
                  const chevron = this.querySelector(".exercise-chevron");
                  explanation.classList.toggle("expanded");
                  chevron.classList.toggle("rotated");
                });

                exercisesContainer.appendChild(card);
              });
              messageContent.appendChild(exercisesContainer);
            } else {
              // Fallback: show raw text
              const routineText = document.createElement("div");
              routineText.className =
                "text-sm whitespace-pre-wrap text-slate-300 leading-relaxed";
              routineText.innerHTML = text.replace(
                /\*\*(.*?)\*\*/g,
                "<strong class='text-white'>$1</strong>"
              );
              messageContent.appendChild(routineText);
            }

            // Add quick action buttons
            const quickActions = document.createElement("div");
            quickActions.className =
              "flex flex-wrap gap-2 pt-3 border-t border-white/10 mt-4";
            quickActions.innerHTML = `
              <button class="quick-action-btn" onclick="adjustRoutine('longer')">
                <i class="fa-solid fa-plus"></i> 5 min
              </button>
              <button class="quick-action-btn" onclick="adjustRoutine('shorter')">
                <i class="fa-solid fa-minus"></i> 5 min
              </button>
              <button class="quick-action-btn" onclick="adjustRoutine('easier')">
                <i class="fa-solid fa-arrow-down"></i> Easier
              </button>
              <button class="quick-action-btn" onclick="adjustRoutine('harder')">
                <i class="fa-solid fa-arrow-up"></i> Harder
              </button>
              <button class="quick-action-btn" onclick="regenerateRoutine()">
                <i class="fa-solid fa-rotate"></i> Regenerate
              </button>
            `;
            messageContent.appendChild(quickActions);
          } else {
            messageContent.className +=
              " text-sm whitespace-pre-wrap message-content";
            messageContent.innerHTML = text.replace(
              /\*\*(.*?)\*\*/g,
              "<strong class='text-white'>$1</strong>"
            );
          }

          const timeEl = document.createElement("div");
          timeEl.className = "message-timestamp";
          timeEl.textContent = timestamp;

          messageBox.appendChild(senderTag);
          messageBox.appendChild(messageContent);
          messageBox.appendChild(timeEl);

          // Add action buttons for bot messages
          const actionsDiv = document.createElement("div");
          actionsDiv.className =
            "mt-4 pt-3 border-t border-white/10 flex gap-2 flex-wrap";
          actionsDiv.innerHTML = `
            <button class="action-btn" onclick="copyMessage(this)" title="Copy to clipboard">
              <i class="fa-solid fa-copy mr-1"></i> Copy
            </button>
            <button class="action-btn" onclick="downloadMessage(this)" title="Download as text file">
              <i class="fa-solid fa-download mr-1"></i> Download
            </button>
            <button class="action-btn" onclick="shareMessage(this)" title="Share message">
              <i class="fa-solid fa-share-nodes mr-1"></i> Share
            </button>
          `;
          messageBox.appendChild(actionsDiv);

          // Save to history if it's a routine
          if (isRoutine && lastUserPrompt) {
            saveToHistory(lastUserPrompt, text);
          }
        }

        messageWrapper.appendChild(messageBox);
        chatMessages.appendChild(messageWrapper);
      }

      // Copy message to clipboard
      window.copyMessage = function (btn) {
        const messageText = btn
          .closest(".bot-message-bubble")
          .querySelector(".message-content").innerText;
        navigator.clipboard.writeText(messageText).then(() => {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copied!';
          btn.classList.add("success");
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove("success");
          }, 2000);
        });
      };

      // Download message as text file
      window.downloadMessage = function (btn) {
        const messageText = btn
          .closest(".bot-message-bubble")
          .querySelector(".message-content").innerText;
        const blob = new Blob([messageText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `stretchletics-routine-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Downloaded!';
        btn.classList.add("success");
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove("success");
        }, 2000);
      };

      // Share message
      window.shareMessage = function (btn) {
        const messageText = btn
          .closest(".bot-message-bubble")
          .querySelector(".message-content").innerText;
        if (navigator.share) {
          navigator
            .share({
              title: "My Stretchletics Routine",
              text: messageText,
            })
            .catch(() => {});
        } else {
          navigator.clipboard.writeText(messageText);
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copied!';
          btn.classList.add("success");
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove("success");
          }, 2000);
        }
      };

      function toggleForm(enabled) {
        chatInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        lastWorkoutBtn.disabled = !enabled;
        chatInput.placeholder = enabled
          ? "Ask me for a routine..."
          : "Generating routine...";

        // Show/hide enhanced loading indicator
        let typingIndicator = document.getElementById("typing-indicator");
        if (!enabled) {
          // Remove old indicator if exists
          if (typingIndicator) typingIndicator.remove();

          // Create and append enhanced loading indicator
          typingIndicator = document.createElement("div");
          typingIndicator.id = "typing-indicator";
          typingIndicator.className = "flex justify-start message-animate";
          typingIndicator.innerHTML = `
            <div class="bot-message-bubble p-4 max-w-xs">
              <div class="loading-progress">
                <div class="flex items-center gap-2 mb-2">
                  <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <span class="loading-text" id="loading-text">Analyzing parameters...</span>
                </div>
                <div class="loading-bar"></div>
              </div>
            </div>
          `;
          chatMessages.appendChild(typingIndicator);
          scrollToBottom();

          // Animate loading text
          let loadingStep = 0;
          const loadingTexts = [
            "Analyzing parameters...",
            "Generating exercises...",
            "Optimizing routine...",
            "Almost ready...",
          ];
          window.loadingInterval = setInterval(() => {
            loadingStep = (loadingStep + 1) % loadingTexts.length;
            const loadingTextEl = document.getElementById("loading-text");
            if (loadingTextEl) {
              loadingTextEl.textContent = loadingTexts[loadingStep];
            }
          }, 1500);
        } else {
          // Remove typing indicator and clear interval
          if (typingIndicator) typingIndicator.remove();
          if (window.loadingInterval) {
            clearInterval(window.loadingInterval);
            window.loadingInterval = null;
          }
        }

        // Change button icon/state when disabled (loading)
        sendButton.innerHTML = enabled
          ? '<i class="fa-solid fa-paper-plane"></i>'
          : `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
      }

      // --- LLM/Routine Generation via Backend ---
      async function generateRoutine(prompt) {
        chatInput.value = "";
        toggleForm(false);

        try {
          // Gather selected equipment
          const equipment = [];
          if (document.getElementById("equipment-roller").checked)
            equipment.push("Foam Roller");
          if (document.getElementById("equipment-bands").checked)
            equipment.push("Resistance Bands");
          if (document.getElementById("equipment-mat").checked)
            equipment.push("Yoga Mat");
          if (document.getElementById("equipment-ball").checked)
            equipment.push("Stability Ball");
          if (document.getElementById("equipment-massage").checked)
            equipment.push("Massage Ball");

          // Gather focus areas
          const focusAreas = [];
          if (document.getElementById("focus-upper").checked)
            focusAreas.push("Upper Body");
          if (document.getElementById("focus-lower").checked)
            focusAreas.push("Lower Body");
          if (document.getElementById("focus-core").checked)
            focusAreas.push("Core");
          if (document.getElementById("focus-full").checked)
            focusAreas.push("Full Body");

          // Build enhanced prompt with parameters
          const routineType = routineTypeInput.value;
          const duration = durationInput.value;
          const difficulty = difficultyInput.value;
          const restrictions = restrictionsInput.value;

          const enhancedPrompt = `${prompt}

Additional Parameters:
- Routine Type: ${routineType}
- Duration: ${duration} minutes
- Difficulty Level: ${difficulty}
${equipment.length > 0 ? `- Equipment Available: ${equipment.join(", ")}` : ""}
${focusAreas.length > 0 ? `- Focus Areas: ${focusAreas.join(", ")}` : ""}
${restrictions ? `- Restrictions/Injuries: ${restrictions}` : ""}`;

          const response = await fetch("http://127.0.0.1:5500/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: enhancedPrompt }),
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const data = await response.json();
          const routineText = data.response;

          addMessage(routineText, "bot", true);
        } catch (error) {
          addMessage(
            `Error generating routine: ${error.message}`,
            "bot",
            false
          );
        }

        toggleForm(true);
        chatInput.value = "";
      }

      // --- Event Listeners ---

      // 1. Handle LLM Chat Request
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const prompt = chatInput.value.trim();
        if (prompt) {
          addMessage(prompt, "user");
          generateRoutine(prompt);
        }
      });

      // 2. Handle Last Workout Button Click
      lastWorkoutBtn.addEventListener("click", () => {
        const workout = mockLastWorkout;
        const routineType = routineTypeInput.value;
        const routineLabel =
          routineType === "warm-up" ? "warm-up" : "cool-down";
        const userPrompt = `Generate a ${routineLabel} routine for my last workout: a ${workout.type} of ${workout.duration}.`;

        addMessage(userPrompt, "user");

        // Trigger the routine generation via backend
        generateRoutine(userPrompt);
      });

      // Chat history storage
      let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");

      // Save to history
      function saveToHistory(userPrompt, botResponse) {
        const historyItem = {
          id: Date.now(),
          userPrompt: userPrompt,
          preview:
            userPrompt.substring(0, 50) + (userPrompt.length > 50 ? "..." : ""),
          response: botResponse,
          timestamp: new Date().toLocaleString(),
        };
        chatHistory.unshift(historyItem);
        if (chatHistory.length > 20) chatHistory.pop();
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
        renderHistory();
      }

      // Render history
      function renderHistory() {
        const historyList = document.getElementById("history-list");
        if (chatHistory.length === 0) {
          historyList.innerHTML =
            '<p class="text-sm text-slate-500 italic text-center py-8">No chat history yet</p>';
          return;
        }
        historyList.innerHTML = chatHistory
          .map(
            (item) => `
          <div class="history-item p-4 rounded-lg" data-id="${item.id}">
            <p class="text-sm font-medium text-white truncate">${item.preview}</p>
            <p class="text-xs text-slate-500 mt-1">${item.timestamp}</p>
          </div>
        `
          )
          .join("");

        document.querySelectorAll(".history-item").forEach((item) => {
          item.addEventListener("click", () => {
            const id = parseInt(item.dataset.id);
            const histItem = chatHistory.find((h) => h.id === id);
            if (histItem) {
              addMessage(histItem.userPrompt, "user");
              addMessage(histItem.response, "bot", true);
              document
                .getElementById("history-sidebar")
                .classList.remove("open");
            }
          });
        });
      }

      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        // Update status with mock data
        lastWorkoutStatus.textContent = `(Last Synced Workout: ${mockLastWorkout.type} on ${mockLastWorkout.date} - ${mockLastWorkout.distance})`;

        // Duration slider update
        const durationInput = document.getElementById("duration-input");
        const durationDisplay = document.getElementById("duration-display");
        window.updateDurationDisplay = function () {
          durationDisplay.textContent = durationInput.value + " min";
        };

        // Initialize active filters
        window.updateActiveFilters = function () {
          // Function kept for compatibility but no longer displays badges
        };

        // Notification system
        window.showNotification = function (message) {
          // Remove existing notification
          const existing = document.querySelector(".param-notification");
          if (existing) existing.remove();

          // Create new notification
          const notification = document.createElement("div");
          notification.className = "param-notification";
          notification.innerHTML = `<i class="fa-solid fa-check-circle"></i>${message}`;
          document.body.appendChild(notification);

          // Auto remove after 3 seconds
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 3000);
        };

        // Collapsible toggle
        window.toggleCollapsible = function (header) {
          const section = header.parentElement;
          const content = section.querySelector(".collapsible-content");
          const icon = header.querySelector(".collapsible-icon");

          content.classList.toggle("expanded");
          icon.classList.toggle("rotated");
        };

        // Parse routine into exercise objects
        window.parseRoutine = function (text) {
          console.log("Parsing routine text:", text); // Debug
          const lines = text.split("\n");
          const exercises = [];
          let i = 0;

          while (i < lines.length) {
            let line = lines[i].trim();

            // Skip empty lines and headers
            if (
              !line ||
              line.toLowerCase().includes("based on") ||
              line.toLowerCase().includes("routine:") ||
              line.toLowerCase().includes("here is")
            ) {
              i++;
              continue;
            }

            // Remove markdown bold markers
            line = line.replace(/\*\*/g, "");

            // Remove "Hold Time:" or "Duration:" labels if present
            line = line.replace(/Hold Time:\s*/gi, "");
            line = line.replace(/Duration:\s*/gi, "");

            let match = null;

            // Pattern 1: "1. Exercise Name - 2 minutes"
            match = line.match(/^(\d+\.)\s*(.+?)\s*[-â€“â€”]\s*(.+)$/i);
            if (match) {
              const name = match[2].trim();
              const duration = match[3].trim();

              // Make sure we didn't just capture the time as the name
              if (
                name.length > 3 &&
                !name.match(/^\d+\s*(sec|min|second|minute)/i)
              ) {
                // Look ahead for instruction (next non-empty line that's not another exercise)
                let explanation = "";
                let j = i + 1;
                while (j < lines.length) {
                  const nextLine = lines[j].trim();
                  // Stop if we hit another numbered exercise or empty line
                  if (!nextLine || /^\d+\./.test(nextLine)) {
                    break;
                  }
                  explanation += (explanation ? " " : "") + nextLine;
                  j++;
                }

                exercises.push({
                  name: name,
                  duration: duration,
                  explanation:
                    explanation ||
                    "Perform this exercise with controlled movements and proper form.",
                });
                console.log(
                  "Matched:",
                  name,
                  "-",
                  duration,
                  "Explanation:",
                  explanation
                );
              }
            }

            // Pattern 2: "- Exercise Name - 2 minutes" (bullet point)
            match = line.match(/^[\-\â€¢\*]\s*(.+?)\s*[-â€“â€”]\s*(.+)$/i);
            if (match) {
              const name = match[1].trim();
              const duration = match[2].trim();
              if (
                name.length > 3 &&
                !name.match(/^\d+\s*(sec|min|second|minute)/i)
              ) {
                let explanation = "";
                let j = i + 1;
                while (j < lines.length) {
                  const nextLine = lines[j].trim();
                  if (!nextLine || /^[\-\â€¢\*]/.test(nextLine)) {
                    break;
                  }
                  explanation += (explanation ? " " : "") + nextLine;
                  j++;
                }

                exercises.push({
                  name: name,
                  duration: duration,
                  explanation:
                    explanation ||
                    "Perform this exercise with controlled movements and proper form.",
                });
                console.log(
                  "Matched bullet:",
                  name,
                  "-",
                  duration,
                  "Explanation:",
                  explanation
                );
              }
            }

            i++;
          }

          console.log("Total exercises parsed:", exercises.length);
          return exercises;
        };

        // Calculate total duration
        window.calculateTotalDuration = function (exercises) {
          let total = 0;
          exercises.forEach((ex) => {
            const match = ex.duration.match(/\d+/);
            if (match) {
              const value = parseInt(match[0]);
              if (ex.duration.includes("sec")) {
                total += value / 60;
              } else {
                total += value;
              }
            }
          });
          return Math.round(total);
        };

        // Quick action handlers
        window.adjustRoutine = function (action) {
          const durationInput = document.getElementById("duration-input");
          const difficultyInput = document.getElementById("difficulty-input");

          switch (action) {
            case "longer":
              durationInput.value = Math.min(
                60,
                parseInt(durationInput.value) + 5
              );
              updateDurationDisplay();
              updateActiveFilters();
              regenerateRoutine();
              break;
            case "shorter":
              durationInput.value = Math.max(
                5,
                parseInt(durationInput.value) - 5
              );
              updateDurationDisplay();
              updateActiveFilters();
              regenerateRoutine();
              break;
            case "easier":
              if (difficultyInput.value === "advanced")
                difficultyInput.value = "intermediate";
              else if (difficultyInput.value === "intermediate")
                difficultyInput.value = "beginner";
              updateActiveFilters();
              regenerateRoutine();
              break;
            case "harder":
              if (difficultyInput.value === "beginner")
                difficultyInput.value = "intermediate";
              else if (difficultyInput.value === "intermediate")
                difficultyInput.value = "advanced";
              updateActiveFilters();
              regenerateRoutine();
              break;
          }
        };

        window.regenerateRoutine = function () {
          if (lastUserPrompt) {
            addMessage(lastUserPrompt, "user");
            generateRoutine(lastUserPrompt);
          }
        };

        // Global routine timer functionality
        const activeRoutineTimers = {};

        window.parseDurationToSeconds = function (duration) {
          const match = duration.match(/(\d+)\s*(min|minute|sec|second)s?/i);
          if (!match) return 30;

          const value = parseInt(match[1]);
          const unit = match[2].toLowerCase();

          if (unit.startsWith("min")) {
            return value * 60;
          }
          return value;
        };

        window.formatTime = function (seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins}:${secs.toString().padStart(2, "0")}`;
        };

        window.toggleRoutineTimer = function (routineId) {
          const state = activeRoutineTimers[routineId];
          const toggleBtn = document.getElementById(`toggle-${routineId}`);

          if (!state || !state.paused) {
            // Currently running or not started, so pause
            if (state) {
              pauseRoutineTimer(routineId);
              toggleBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
              toggleBtn.title = "Resume routine";
            } else {
              // Start new routine
              startRoutineTimer(routineId);
              toggleBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
              toggleBtn.title = "Pause routine";
            }
          } else {
            // Currently paused, so resume
            continueRoutineTimer(routineId, state);
            toggleBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            toggleBtn.title = "Pause routine";
          }
        };

        window.skipExercise = function (routineId) {
          const state = activeRoutineTimers[routineId];
          if (!state || state.paused) return;

          // Mark current as completed
          const currentExercise = state.exercises[state.currentIndex];
          if (currentExercise) {
            currentExercise.card.classList.remove("active");
            currentExercise.card.classList.add("completed");
          }

          // Move to next
          state.currentIndex++;

          // Check if we've completed all exercises
          if (state.currentIndex >= state.exercises.length) {
            completeRoutine(routineId);
            return;
          }

          activeRoutineTimers[routineId] = state;
          startNextExercise(routineId);
        };

        window.startRoutineTimer = function (routineId) {
          const timerContainer = document.getElementById(routineId);
          const exerciseCards =
            timerContainer.parentElement.querySelectorAll(".exercise-card");

          if (!exerciseCards.length) return;

          // If resuming, use existing state
          if (activeRoutineTimers[routineId]?.paused) {
            const state = activeRoutineTimers[routineId];
            continueRoutineTimer(routineId, state);
            return;
          }

          // Build exercise list
          const exercises = Array.from(exerciseCards).map((card) => ({
            card: card,
            duration: parseInt(card.getAttribute("data-duration")),
            name: card.querySelector("h4").textContent,
          }));

          const totalDuration = exercises.reduce(
            (sum, ex) => sum + ex.duration,
            0
          );

          timerContainer.classList.add("running");

          const state = {
            exercises: exercises,
            currentIndex: 0,
            totalDuration: totalDuration,
            elapsedTotal: 0,
            paused: false,
            interval: null,
          };

          activeRoutineTimers[routineId] = state;
          startNextExercise(routineId);
        };

        function continueRoutineTimer(routineId, state) {
          state.paused = false;
          activeRoutineTimers[routineId] = state;
          const timerContainer = document.getElementById(routineId);
          timerContainer.classList.add("running");

          startNextExercise(routineId);
        }

        function startNextExercise(routineId) {
          const state = activeRoutineTimers[routineId];
          if (!state || state.paused) return;

          // Clear any existing interval
          if (state.interval) {
            clearInterval(state.interval);
            state.interval = null;
          }

          if (state.currentIndex >= state.exercises.length) {
            completeRoutine(routineId);
            return;
          }

          const currentExercise = state.exercises[state.currentIndex];
          let remainingSeconds = currentExercise.duration;

          // Update UI
          const timerContainer = document.getElementById(routineId);
          const display = document.getElementById(`display-${routineId}`);
          const currentName = document.getElementById(`current-${routineId}`);
          const progressText = document.getElementById(
            `progress-text-${routineId}`
          );
          const routineProgress = document.getElementById(
            `routine-progress-${routineId}`
          );

          // Highlight current exercise
          state.exercises.forEach((ex, idx) => {
            ex.card.classList.remove("active", "completed");
            if (idx < state.currentIndex) {
              ex.card.classList.add("completed");
            } else if (idx === state.currentIndex) {
              ex.card.classList.add("active");
            }
          });

          currentName.textContent = currentExercise.name;
          progressText.textContent = `Exercise ${state.currentIndex + 1} of ${
            state.exercises.length
          }`;

          // Scroll to current exercise
          currentExercise.card.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });

          state.interval = setInterval(() => {
            if (state.paused) {
              clearInterval(state.interval);
              state.interval = null;
              return;
            }

            remainingSeconds--;
            state.elapsedTotal++;

            display.textContent = formatTime(remainingSeconds);

            // Update overall progress
            const overallProgress =
              (state.elapsedTotal / state.totalDuration) * 100;
            routineProgress.style.width = overallProgress + "%";

            if (remainingSeconds <= 0) {
              clearInterval(state.interval);
              state.interval = null;

              // Play 1-second beep
              try {
                const audioContext = new (window.AudioContext ||
                  window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800; // 800Hz tone
                oscillator.type = "sine";

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(
                  0.01,
                  audioContext.currentTime + 1
                );

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
              } catch (e) {}

              // Mark as completed
              currentExercise.card.classList.remove("active");
              currentExercise.card.classList.add("completed");

              // Move to next exercise
              state.currentIndex++;
              activeRoutineTimers[routineId] = state;

              // Wait 1 second before next exercise
              setTimeout(() => {
                if (!state.paused) {
                  startNextExercise(routineId);
                }
              }, 1000);
            }
          }, 1000);
        }

        function completeRoutine(routineId) {
          const timerContainer = document.getElementById(routineId);
          const display = document.getElementById(`display-${routineId}`);
          const currentName = document.getElementById(`current-${routineId}`);
          const progressText = document.getElementById(
            `progress-text-${routineId}`
          );
          const routineProgress = document.getElementById(
            `routine-progress-${routineId}`
          );

          timerContainer.classList.remove("running");
          timerContainer.classList.add("timer-complete");

          // Hide the timer display
          display.style.display = "none";

          // Update text to completion message
          currentName.textContent = "Routine Complete! ðŸŽ‰";
          progressText.textContent = "All exercises finished";

          // Hide the progress bar
          routineProgress.parentElement.style.display = "none";

          showNotification("Routine complete! Great work! ðŸ’ª");

          delete activeRoutineTimers[routineId];

          setTimeout(() => {
            timerContainer.classList.remove("timer-complete");
          }, 3000);
        }

        window.pauseRoutineTimer = function (routineId) {
          const state = activeRoutineTimers[routineId];
          if (!state) return;

          state.paused = true;
          const timerContainer = document.getElementById(routineId);
          timerContainer.classList.remove("running");
        };

        window.resetRoutineTimer = function (routineId) {
          const state = activeRoutineTimers[routineId];
          if (state) {
            // Clear any active interval
            if (state.interval) {
              clearInterval(state.interval);
              state.interval = null;
            }
            state.paused = true;
            delete activeRoutineTimers[routineId];
          }

          const timerContainer = document.getElementById(routineId);
          const display = document.getElementById(`display-${routineId}`);
          const currentName = document.getElementById(`current-${routineId}`);
          const progressText = document.getElementById(
            `progress-text-${routineId}`
          );
          const routineProgress = document.getElementById(
            `routine-progress-${routineId}`
          );
          const exerciseCards =
            timerContainer.parentElement.querySelectorAll(".exercise-card");
          const toggleBtn = document.getElementById(`toggle-${routineId}`);

          timerContainer.classList.remove("running", "timer-complete");
          display.textContent = "0:00";
          currentName.textContent = "Ready to start";
          progressText.textContent = `Exercise 0 of ${exerciseCards.length}`;
          routineProgress.style.width = "0%";

          // Reset toggle button
          if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
            toggleBtn.title = "Start routine";
          }

          exerciseCards.forEach((card) => {
            card.classList.remove("active", "completed");
          });
        };

        // Initialize
        updateActiveFilters();

        // Voice input functionality
        const voiceButton = document.getElementById("voice-button");
        let recognition = null;

        if (
          "webkitSpeechRecognition" in window ||
          "SpeechRecognition" in window
        ) {
          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = "en-US";

          recognition.onstart = () => {
            voiceButton.classList.add("listening");
            voiceButton.innerHTML =
              '<i class="fa-solid fa-circle text-red-500"></i>';
          };

          recognition.onend = () => {
            voiceButton.classList.remove("listening");
            voiceButton.innerHTML = '<i class="fa-solid fa-microphone"></i>';
          };

          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            chatInput.focus();
          };

          recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            voiceButton.classList.remove("listening");
            voiceButton.innerHTML = '<i class="fa-solid fa-microphone"></i>';
          };

          voiceButton.addEventListener("click", () => {
            if (voiceButton.classList.contains("listening")) {
              recognition.stop();
            } else {
              recognition.start();
            }
          });
        } else {
          voiceButton.style.display = "none"; // Hide if not supported
        }

        // Quick prompt function - auto send
        window.useQuickPrompt = function (btn) {
          const text = btn.textContent.trim();
          chatInput.value = text;
          addMessage(text, "user");
          generateRoutine(text);
          chatInput.value = "";
        };

        // Example chips click handlers - auto send all chips
        document.querySelectorAll(".example-chip").forEach((chip) => {
          chip.addEventListener("click", () => {
            const text = chip.textContent.trim();
            addMessage(text, "user");
            generateRoutine(text);
          });
        });

        // Burger menu toggle
        const burgerMenu = document.getElementById("burger-menu");
        const historySidebar = document.getElementById("history-sidebar");
        const closeHistory = document.getElementById("close-history");

        burgerMenu.addEventListener("click", () => {
          historySidebar.classList.toggle("open");
        });

        closeHistory.addEventListener("click", () => {
          historySidebar.classList.remove("open");
        });

        // Clear history
        document
          .getElementById("clear-history")
          .addEventListener("click", () => {
            if (confirm("Clear all chat history?")) {
              chatHistory = [];
              localStorage.removeItem("chatHistory");
              renderHistory();
            }
          });

        // Initial history render
        renderHistory();
      });
    </script>
  </body>
</html>
