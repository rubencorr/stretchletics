<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Training Plan - Stretchletics</title>
    <link rel="icon" type="image/png" href="../media/logo_round.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "neon-pink": "#EC4899",
              "neon-indigo": "#4F46E5",
              "deep-black": "#050505",
              "dark-charcoal": "#10141D",
              "deep-navy": "#1D2A4A",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap");
      :root {
        font-family: "Inter", sans-serif;
      }

      /* Floating Orbs with enhanced animation */
      .bg-orb {
        position: fixed;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.6;
        animation: float-orb 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
      }

      .bg-orb-1 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(236, 72, 153, 0.5), transparent);
        top: -100px;
        left: -150px;
      }

      .bg-orb-2 {
        width: 350px;
        height: 350px;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.5), transparent);
        bottom: -80px;
        right: -120px;
        animation-delay: 7s;
      }

      .bg-orb-3 {
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(14, 165, 233, 0.4), transparent);
        top: 50%;
        right: 10%;
        animation-delay: 14s;
      }

      @keyframes float-orb {
        0%, 100% { transform: translate(0, 0) scale(1); }
        25% { transform: translate(30px, -40px) scale(1.15); }
        50% { transform: translate(-30px, 40px) scale(0.85); }
        75% { transform: translate(40px, 30px) scale(1.05); }
      }

      /* Hide scrollbars */
      ::-webkit-scrollbar {
        display: none;
      }
      * {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Wizard Steps Container */
      .wizard-step {
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
        position: absolute;
        width: 100%;
      }

      .wizard-step.active {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
        position: relative;
      }

      .wizard-step.exiting {
        opacity: 0;
        transform: translateX(-100px);
      }

      .wizard-step.exiting-reverse {
        opacity: 0;
        transform: translateX(100px);
      }

      .wizard-step.entering-reverse {
        transform: translateX(-100px);
      }

      .wizard-step.active.entering-reverse {
        opacity: 1;
        transform: translateX(0);
      }

      /* Progress Bar */
      .progress-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ec4899, #4f46e5);
        transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.6);
      }

      /* Step Indicators */
      .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        transition: all 0.4s ease;
        position: relative;
        cursor: pointer;
      }

      .step-indicator:hover {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.15);
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.4);
      }

      .step-indicator.completed {
        border-color: #ec4899;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
      }

      .step-indicator.active {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.2);
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.6);
        animation: pulse-ring 2s infinite;
      }

      @keyframes pulse-ring {
        0%, 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
        50% { box-shadow: 0 0 0 15px rgba(236, 72, 153, 0); }
      }

      /* Sport Cards Enhanced */
      .sport-card {
        background: rgba(255, 255, 255, 0.04);
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .sport-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(236, 72, 153, 0.15), transparent);
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .sport-card:hover {
        border-color: rgba(236, 72, 153, 0.6);
        background: rgba(236, 72, 153, 0.08);
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 40px rgba(236, 72, 153, 0.3);
      }

      .sport-card:hover::before {
        opacity: 1;
      }

      .sport-card.selected {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.15);
        box-shadow: 0 0 40px rgba(236, 72, 153, 0.5), inset 0 0 40px rgba(236, 72, 153, 0.1);
        transform: scale(1.05);
      }

      .sport-card.selected::before {
        opacity: 1;
      }

      .sport-card i {
        transition: all 0.3s ease;
      }

      .sport-card:hover i {
        transform: scale(1.2) rotate(5deg);
      }

      .sport-card.selected i {
        transform: scale(1.3);
      }

      /* Flip swim icon */
      .swim-icon {
        transform: scaleX(-1);
      }

      .sport-card:hover .swim-icon {
        transform: scaleX(-1) scale(1.2) rotate(5deg);
      }

      .sport-card.selected .swim-icon {
        transform: scaleX(-1) scale(1.3);
      }

      /* Equipment Cards */
      .equipment-card {
        background: rgba(255, 255, 255, 0.02);
        border: 2px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
      }

      .equipment-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(79, 70, 229, 0.1));
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .equipment-card:hover {
        border-color: rgba(236, 72, 153, 0.5);
        background: rgba(255, 255, 255, 0.04);
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(236, 72, 153, 0.3);
      }

      .equipment-card:hover::before {
        opacity: 0.5;
      }

      .equipment-card.selected {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.15);
        box-shadow: 0 0 40px rgba(236, 72, 153, 0.5), inset 0 0 40px rgba(236, 72, 153, 0.1);
        transform: scale(1.05);
      }

      .equipment-card.selected::before {
        opacity: 1;
      }

      .equipment-card.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: #ec4899;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.5);
      }

      .equipment-card i {
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .equipment-card:hover i {
        transform: scale(1.2) rotate(5deg);
      }

      .equipment-card.selected i {
        transform: scale(1.3);
      }

      /* Goal Distance Cards */
      .goal-distance-card,
      .fitness-level-card,
      .improvement-card {
        background: linear-gradient(135deg, rgba(15, 15, 30, 0.9), rgba(30, 15, 45, 0.9));
        border: 2px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
        padding: 24px 20px;
        border-radius: 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 140px;
      }

      .goal-distance-card::before,
      .fitness-level-card::before,
      .improvement-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(79, 70, 229, 0.15));
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .goal-distance-card:hover,
      .fitness-level-card:hover,
      .improvement-card:hover {
        border-color: rgba(236, 72, 153, 0.6);
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(79, 70, 229, 0.1));
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 12px 40px rgba(236, 72, 153, 0.4);
      }

      .goal-distance-card:hover::before,
      .fitness-level-card:hover::before,
      .improvement-card:hover::before {
        opacity: 0.6;
      }

      .goal-distance-card.selected,
      .fitness-level-card.selected,
      .improvement-card.selected {
        border-color: #ec4899;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(79, 70, 229, 0.25));
        box-shadow: 0 0 50px rgba(236, 72, 153, 0.6), inset 0 0 60px rgba(236, 72, 153, 0.15);
        transform: scale(1.08);
      }

      .goal-distance-card.selected::before,
      .fitness-level-card.selected::before,
      .improvement-card.selected::before {
        opacity: 1;
      }

      .goal-distance-card.selected::after,
      .fitness-level-card.selected::after,
      .improvement-card.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 26px;
        height: 26px;
        background: linear-gradient(135deg, #ec4899, #f472b6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: white;
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.6);
        z-index: 2;
      }

      /* Goal Distance Card Content Styles */
      .goal-distance-title {
        font-size: 20px;
        font-weight: 900;
        color: white;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 1;
        line-height: 1.2;
      }

      .goal-distance-subtitle {
        font-size: 11px;
        color: #94a3b8;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        position: relative;
        z-index: 1;
      }

      .goal-distance-card.selected .goal-distance-title {
        color: #f472b6;
      }

      .goal-distance-card.selected .goal-distance-subtitle {
        color: #e2e8f0;
      }

      /* Gradient Buttons */
      .gradient-button {
        background: linear-gradient(135deg, #4f46e5 0%, #ec4899 100%);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
      }

      .gradient-button::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, #ec4899 0%, #4f46e5 100%);
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .gradient-button:hover::before {
        opacity: 1;
      }

      .gradient-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(236, 72, 153, 0.5);
      }

      .gradient-button span,
      .gradient-button i {
        position: relative;
        z-index: 1;
      }

      .gradient-button:disabled {
        cursor: not-allowed;
        transform: none;
      }

      /* Secondary Button */
      .secondary-button {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .secondary-button:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(236, 72, 153, 0.4);
        transform: translateY(-2px);
      }

      /* Enhanced Input Fields */
      input[type="text"],
      input[type="number"],
      input[type="date"],
      textarea {
        background: rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        color-scheme: dark;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="date"]:focus,
      textarea:focus {
        background: rgba(0, 0, 0, 0.6);
        border-color: #ec4899;
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1), 0 0 20px rgba(236, 72, 153, 0.3);
        transform: translateY(-2px);
      }

      /* Range Slider Enhanced */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        position: relative;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        cursor: pointer;
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2), 0 4px 20px rgba(236, 72, 153, 0.6);
        transition: all 0.3s ease;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 0 6px rgba(236, 72, 153, 0.3), 0 6px 30px rgba(236, 72, 153, 0.8);
      }

      input[type="range"]::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899, #4f46e5);
        cursor: pointer;
        border: none;
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2), 0 4px 20px rgba(236, 72, 153, 0.6);
        transition: all 0.3s ease;
      }

      input[type="range"]::-moz-range-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 0 6px rgba(236, 72, 153, 0.3), 0 6px 30px rgba(236, 72, 153, 0.8);
      }

      /* Slider Fill Effect */
      input[type="range"] {
        background: linear-gradient(to right, #ec4899 0%, #ec4899 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 100%);
        background-size: 200% 100%;
      }

      /* Plan Display */
      .plan-content {
        line-height: 1.9;
      }

      /* Week Card Styling */
      .week-card {
        background: linear-gradient(
          135deg,
          rgba(79, 70, 229, 0.05),
          rgba(236, 72, 153, 0.05)
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 0;
        margin: 16px 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      .week-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(180deg, #ec4899, #4f46e5);
        opacity: 0.6;
        transition: opacity 0.3s ease;
      }

      .week-card:hover {
        border-color: rgba(236, 72, 153, 0.3);
        box-shadow: 0 4px 16px rgba(236, 72, 153, 0.2);
        transform: translateY(-2px);
      }

      .week-card:hover::before {
        opacity: 1;
      }

      .week-card.expanded {
        border-color: rgba(236, 72, 153, 0.4);
        box-shadow: 0 6px 20px rgba(236, 72, 153, 0.25);
      }

      /* Workout Card Styling */
      .workout-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
        transition: all 0.3s ease;
      }

      .workout-card:hover {
        background: rgba(0, 0, 0, 0.4);
        border-color: rgba(236, 72, 153, 0.2);
        transform: translateX(4px);
      }

      .week-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s ease, padding 0.3s ease;
        opacity: 0;
        padding: 0 24px;
      }

      .week-content.expanded {
        max-height: 3000px;
        opacity: 1;
        padding: 24px;
      }

      .week-chevron {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #94a3b8;
        opacity: 0.7;
      }

      .week-card:hover .week-chevron {
        color: #ec4899;
        opacity: 1;
      }

      .week-chevron.rotated {
        transform: rotate(180deg);
        color: #ec4899;
        opacity: 1;
      }

      .week-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(236, 72, 153, 0.2),
          rgba(79, 70, 229, 0.2)
        );
        border: 1px solid rgba(236, 72, 153, 0.3);
        color: #f472b6;
        font-weight: 800;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .workout-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .workout-type-easy {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
      }

      .workout-type-moderate {
        background: rgba(251, 191, 36, 0.2);
        border: 1px solid rgba(251, 191, 36, 0.3);
        color: #fbbf24;
      }

      .workout-type-hard {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
      }

      .workout-type-recovery {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #60a5fa;
      }

      .plan-section-header {
        background: linear-gradient(
          135deg,
          rgba(79, 70, 229, 0.1),
          rgba(236, 72, 153, 0.1)
        );
        border: 1px solid rgba(236, 72, 153, 0.2);
        border-radius: 12px;
        padding: 16px 20px;
        margin: 24px 0 16px 0;
      }

      .plan-section-header h2 {
        color: #ec4899;
        font-weight: 800;
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
      }

      .workout-detail-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
        font-size: 13px;
      }

      .workout-icon {
        width: 20px;
        text-align: center;
        color: #ec4899;
        opacity: 0.8;
      }

      /* Date Mode Cards */
      .date-mode-card {
        background: rgba(255, 255, 255, 0.04);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .date-mode-card:hover {
        border-color: rgba(236, 72, 153, 0.4);
        background: rgba(236, 72, 153, 0.08);
        transform: translateY(-4px);
      }

      .date-mode-card.active {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.15);
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.4);
      }

      /* Calendar View Styles */
      .calendar-container {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 16px;
        padding: 24px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .calendar-nav-btn {
        background: rgba(236, 72, 153, 0.2);
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-radius: 8px;
        padding: 8px 16px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .calendar-nav-btn:hover {
        background: rgba(236, 72, 153, 0.4);
        transform: translateY(-2px);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr) 200px;
        gap: 8px;
      }

      .calendar-weekday {
        text-align: center;
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        color: #ec4899;
        padding: 8px;
        letter-spacing: 0.5px;
      }

      .calendar-day-cell {
        aspect-ratio: 1;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(17, 24, 39, 0.8));
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 10px;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .calendar-day-cell::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(79, 70, 229, 0.2));
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .calendar-day-cell:hover {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(31, 41, 55, 0.9));
        border-color: rgba(236, 72, 153, 0.5);
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 24px rgba(236, 72, 153, 0.3);
      }

      .calendar-day-cell:hover::before {
        opacity: 0.3;
      }

      .calendar-day-cell.has-workout {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(79, 70, 229, 0.15));
        border-color: rgba(236, 72, 153, 0.5);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

      .calendar-day-cell.has-workout::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #ec4899, #4f46e5);
        border-radius: 0 0 10px 10px;
      }

      .calendar-day-cell.has-workout:hover {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(79, 70, 229, 0.25));
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.4), 0 8px 24px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateY(-6px) scale(1.03);
      }

      .calendar-day-cell.has-workout:hover::before {
        opacity: 0.5;
      }

      .calendar-day-cell.other-month {
        opacity: 0.3;
        pointer-events: none;
      }

      .calendar-day-cell.other-month:hover {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(17, 24, 39, 0.8));
        border-color: rgba(255, 255, 255, 0.08);
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .calendar-day-cell.other-month:hover::before {
        opacity: 0;
      }

      .calendar-day-cell.today {
        border: 3px solid #fbbf24;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(251, 191, 36, 0.1);
      }

      .calendar-day-cell.today .calendar-day-number {
        color: #fbbf24;
        font-size: 18px;
      }

      .calendar-day-cell.today::before {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
        opacity: 1;
      }

      .calendar-day-number {
        font-weight: 800;
        font-size: 16px;
        color: white;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .calendar-workout-name {
        font-size: 11px;
        color: #fbbf24;
        font-weight: 700;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        position: relative;
        z-index: 1;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        background: linear-gradient(135deg, #fbbf24, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Workout Detail Modal */
      .workout-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }

      .workout-modal {
        background: linear-gradient(135deg, rgba(16, 20, 29, 0.95), rgba(5, 5, 5, 0.95));
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 32px;
        position: relative;
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(236, 72, 153, 0.4);
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .modal-close-btn:hover {
        background: rgba(236, 72, 153, 0.2);
        border-color: rgba(236, 72, 153, 0.4);
        color: #ec4899;
        transform: rotate(90deg);
      }

      .modal-header {
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(236, 72, 153, 0.2);
      }

      .modal-date {
        font-size: 14px;
        color: #ec4899;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 900;
        color: white;
        margin-bottom: 0;
      }

      .modal-workout-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .modal-workout-item {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s ease;
        margin-bottom: 8px;
      }

      .modal-workout-item:hover {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(79, 70, 229, 0.05));
        border-color: rgba(236, 72, 153, 0.4);
        box-shadow: 0 4px 20px rgba(236, 72, 153, 0.15);
      }

      .modal-workout-item-text {
        color: #e2e8f0;
        font-size: 14px;
        line-height: 1.6;
      }

      .workout-detail-header {
        margin-bottom: 16px;
      }

      .workout-name {
        font-size: 18px;
        font-weight: 700;
        color: white;
        margin: 0;
      }

      .workout-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin: 16px 0;
      }

      .workout-stat-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
      }

      .workout-stat-card:hover {
        background: rgba(236, 72, 153, 0.1);
        border-color: rgba(236, 72, 153, 0.4);
        transform: translateY(-2px);
      }

      .workout-stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(79, 70, 229, 0.3));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .workout-stat-icon i {
        font-size: 18px;
        color: #ec4899;
      }

      .workout-stat-label {
        font-size: 11px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .workout-stat-value {
        font-size: 16px;
        font-weight: 700;
        color: white;
      }

      /* Export Dropdown */
      .export-dropdown-container {
        position: relative;
      }

      .export-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: linear-gradient(135deg, rgba(16, 20, 29, 0.98), rgba(5, 5, 5, 0.98));
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 16px;
        padding: 8px;
        min-width: 240px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(236, 72, 153, 0.3);
        z-index: 100;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .export-dropdown.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }

      .export-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 6px;
      }

      .export-option:last-child {
        margin-bottom: 0;
      }

      .export-option:hover {
        background: rgba(236, 72, 153, 0.15);
        border-color: rgba(236, 72, 153, 0.4);
        transform: translateX(4px);
      }

      .export-option i {
        width: 20px;
        text-align: center;
        color: #ec4899;
      }

      .export-option-text {
        flex: 1;
      }

      .export-option-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .export-option-desc {
        font-size: 11px;
        color: #94a3b8;
      }

      /* Export Dropdown */
      .export-dropdown-container {
        position: relative;
      }

      .export-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: linear-gradient(135deg, rgba(16, 20, 29, 0.98), rgba(5, 5, 5, 0.98));
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 16px;
        padding: 8px;
        min-width: 240px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(236, 72, 153, 0.3);
        z-index: 100;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .export-dropdown.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }

      .export-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 6px;
      }

      .export-option:last-child {
        margin-bottom: 0;
      }

      .export-option:hover {
        background: rgba(236, 72, 153, 0.15);
        border-color: rgba(236, 72, 153, 0.4);
        transform: translateX(4px);
      }

      .export-option i {
        width: 20px;
        text-align: center;
        color: #ec4899;
      }

      .export-option-text {
        flex: 1;
      }

      .export-option-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .export-option-desc {
        font-size: 11px;
        color: #94a3b8;
      }

      .workout-full-description {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .workout-full-description p {
        color: #cbd5e1;
        font-size: 14px;
        line-height: 1.6;
        margin: 0;
      }

      .week-summary {
        grid-row: span 1;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(79, 70, 229, 0.1));
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .week-summary-title {
        font-weight: 700;
        font-size: 12px;
        color: #ec4899;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .week-summary-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }

      .week-summary-label {
        color: #94a3b8;
      }

      .week-summary-value {
        color: white;
        font-weight: 700;
      }

      /* Card Glow Effect */
      .card-glow {
        box-shadow: 0 0 40px rgba(236, 72, 153, 0.1);
      }

      /* Fade In Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.6s ease-out;
      }

      /* Loading Spinner */
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #ec4899;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Toast Notifications */
      .toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .toast {
        min-width: 320px;
        background: linear-gradient(135deg, rgba(16, 20, 29, 0.98), rgba(5, 5, 5, 0.98));
        border-radius: 16px;
        padding: 16px 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        backdrop-filter: blur(20px);
      }

      .toast.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideOutRight {
        to {
          opacity: 0;
          transform: translateX(120%);
        }
      }

      .toast-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 18px;
      }

      .toast.success .toast-icon {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));
        color: #22c55e;
        border: 2px solid rgba(34, 197, 94, 0.4);
      }

      .toast.error .toast-icon {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        color: #ef4444;
        border: 2px solid rgba(239, 68, 68, 0.4);
      }

      .toast.info .toast-icon {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
        color: #3b82f6;
        border: 2px solid rgba(59, 130, 246, 0.4);
      }

      .toast-content {
        flex: 1;
      }

      .toast-message {
        color: white;
        font-weight: 600;
        font-size: 14px;
        line-height: 1.5;
      }

      /* Plan Reveal Animation */
      @keyframes planReveal {
        0% {
          opacity: 0;
          transform: scale(0.95) translateY(20px);
        }
        60% {
          opacity: 1;
          transform: scale(1.02) translateY(0);
        }
        100% {
          transform: scale(1) translateY(0);
        }
      }

      .plan-reveal {
        animation: planReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes celebrationPulse {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7);
        }
        50% {
          box-shadow: 0 0 0 30px rgba(236, 72, 153, 0);
        }
      }

      .celebration-pulse {
        animation: celebrationPulse 1s ease-out;
      }
    </style>
  </head>

  <body class="bg-deep-black text-slate-300 antialiased h-screen overflow-hidden">
    <!-- Floating background orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Wizard Container -->
    <div id="wizard-overlay" class="fixed inset-0 z-10 flex items-center justify-center p-8">
      <div class="w-full max-w-6xl h-full flex flex-col">
        
        <!-- Wizard Header -->
        <div class="text-center mb-8 fade-in">
          <h1 class="text-5xl font-black text-white uppercase tracking-wider mb-3">
            <i class="fa-solid fa-calendar-days text-neon-pink mr-3"></i>
            Training Plan
          </h1>
          <p class="text-lg text-slate-400">Let's build your perfect training journey</p>
        </div>

        <!-- Progress Indicators -->
        <div class="mb-8 fade-in">
          <div class="flex items-center justify-between max-w-2xl mx-auto mb-4">
            <div class="flex flex-col items-center step-container" data-step="1" onclick="tryGoToStep(1)">
              <div class="step-indicator active" data-step="1">
                <i class="fas fa-flag-checkered text-sm"></i>
              </div>
              <span class="text-xs mt-2 font-semibold text-white">Basics</span>
            </div>
            <div class="flex-1 h-0.5 bg-white/10 mx-4"></div>
            <div class="flex flex-col items-center step-container" data-step="2" onclick="tryGoToStep(2)">
              <div class="step-indicator" data-step="2">
                <i class="fas fa-bullseye text-sm"></i>
              </div>
              <span class="text-xs mt-2 font-semibold text-slate-400">Goals</span>
            </div>
            <div class="flex-1 h-0.5 bg-white/10 mx-4"></div>
            <div class="flex flex-col items-center step-container" data-step="3" onclick="tryGoToStep(3)">
              <div class="step-indicator" data-step="3">
                <i class="fas fa-gears text-sm"></i>
              </div>
              <span class="text-xs mt-2 font-semibold text-slate-400">Equipment</span>
            </div>
            <div class="flex-1 h-0.5 bg-white/10 mx-4"></div>
            <div class="flex flex-col items-center step-container" data-step="4" onclick="tryGoToStep(4)">
              <div class="step-indicator" data-step="4">
                <i class="fas fa-calendar-days text-sm"></i>
              </div>
              <span class="text-xs mt-2 font-semibold text-slate-400">Schedule</span>
            </div>
            <div class="flex-1 h-0.5 bg-white/10 mx-4"></div>
            <div class="flex flex-col items-center step-container" data-step="5" onclick="tryGoToStep(5)">
              <div class="step-indicator" data-step="5">
                <i class="fas fa-check text-sm"></i>
              </div>
              <span class="text-xs mt-2 font-semibold text-slate-400">Review</span>
            </div>
          </div>
          <div class="progress-bar max-w-2xl mx-auto">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Steps Container -->
        <div class="flex-1 overflow-y-auto mb-6 relative">
          
          <!-- Step 1: Basics -->
          <div class="wizard-step active" data-step="1">
            <div class="max-w-4xl mx-auto bg-black/30 backdrop-blur-xl rounded-3xl border border-white/10 p-12 card-glow fade-in">
              <h2 class="text-3xl font-black text-white mb-3 flex items-center">
                <i class="fas fa-flag-checkered text-neon-pink mr-3"></i>
                Let's Start with the Basics
              </h2>
              <p class="text-slate-400 mb-10">Tell us about your training plan and sport preference</p>
              
              <div class="space-y-8">
                <!-- Plan Name -->
                <div>
                  <label class="block text-sm font-bold text-white uppercase tracking-wider mb-3">
                    What should we call your training plan?
                  </label>
                  <input
                    type="text"
                    id="plan-name"
                    placeholder="e.g. Berlin Marathon Prep"
                    class="w-full p-4 rounded-2xl text-white text-lg focus:outline-none"
                  />
                </div>

                <!-- Sport Selection -->
                <div>
                  <label class="block text-sm font-bold text-white uppercase tracking-wider mb-4">
                    Choose Your Sport
                  </label>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="sport-card rounded-2xl p-6 text-center" data-sport="running">
                      <i class="fas fa-running text-5xl text-neon-pink mb-3"></i>
                      <p class="text-base font-bold">Running</p>
                    </div>
                    <div class="sport-card rounded-2xl p-6 text-center" data-sport="cycling">
                      <i class="fas fa-biking text-5xl text-neon-indigo mb-3"></i>
                      <p class="text-base font-bold">Cycling</p>
                    </div>
                    <div class="sport-card rounded-2xl p-6 text-center" data-sport="swimming">
                      <i class="fas fa-person-swimming swim-icon text-5xl text-cyan-400 mb-3"></i>
                      <p class="text-base font-bold">Swimming</p>
                    </div>
                    <div class="sport-card rounded-2xl p-6 text-center" data-sport="triathlon">
                      <i class="fas fa-medal text-5xl text-yellow-400 mb-3"></i>
                      <p class="text-base font-bold">Triathlon</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Goals -->
          <div class="wizard-step" data-step="2">
            <div class="max-w-4xl mx-auto bg-black/30 backdrop-blur-xl rounded-3xl border border-white/10 p-12 card-glow fade-in">
              <h2 class="text-3xl font-black text-white mb-3 flex items-center">
                <i class="fas fa-bullseye text-neon-pink mr-3"></i>
                Set Your Goals
              </h2>
              <p class="text-slate-400 mb-10">Define where you are and where you want to be</p>
              
              <div class="space-y-8">
                <!-- Event/Distance Selection -->
                <div>
                  <label class="block text-sm font-bold text-white uppercase tracking-wider mb-4">
                    Target Event or Distance
                  </label>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="goal-distance-card" data-distance="5k">
                      <div class="goal-distance-title">5K</div>
                      <div class="goal-distance-subtitle">Parkrun</div>
                    </div>
                    <div class="goal-distance-card" data-distance="10k">
                      <div class="goal-distance-title">10K</div>
                      <div class="goal-distance-subtitle">10 kilometers</div>
                    </div>
                    <div class="goal-distance-card" data-distance="half-marathon">
                      <div class="goal-distance-title">21.1km</div>
                      <div class="goal-distance-subtitle">Half Marathon</div>
                    </div>
                    <div class="goal-distance-card" data-distance="marathon">
                      <div class="goal-distance-title">42.2 km</div>
                      <div class="goal-distance-subtitle">Marathon</div>
                    </div>
                    <div class="goal-distance-card" data-distance="50k">
                      <div class="goal-distance-title">50K</div>
                      <div class="goal-distance-subtitle">Ultra I</div>
                    </div>
                    <div class="goal-distance-card" data-distance="100k">
                      <div class="goal-distance-title">100K</div>
                      <div class="goal-distance-subtitle">Ultra II</div>
                    </div>
                    <div class="goal-distance-card" data-distance="custom">
                      <div class="goal-distance-title">Custom</div>
                      <div class="goal-distance-subtitle">Your distance</div>
                    </div>
                  </div>
                </div>

                <!-- Current Performance Level -->
                <div>
                  <label class="block text-sm font-bold text-white uppercase tracking-wider mb-6 text-center">
                    <i class="fas fa-stopwatch text-neon-pink mr-2"></i>
                    Enter Your Times
                  </label>
                  <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-black/40 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/10 hover:border-neon-pink/50 transition-all">
                      <div class="flex items-center justify-center gap-2 mb-3">
                        <i class="fas fa-clock text-blue-400 text-xl"></i>
                        <label class="text-base font-bold text-white uppercase tracking-wider">
                          Current Time
                        </label>
                      </div>
                      <input
                        type="time"
                        id="current-performance"
                        step="1"
                        class="w-full p-4 rounded-xl text-white text-2xl text-center font-bold focus:outline-none bg-black/50 border-2 border-white/20 focus:border-blue-400 focus:ring-4 focus:ring-blue-400/20"
                        style="color-scheme: dark;"
                      />
                      <p class="text-xs text-slate-400 mt-3 text-center font-semibold">Your current performance</p>
                    </div>
                    <div class="bg-black/40 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/10 hover:border-neon-pink/50 transition-all">
                      <div class="flex items-center justify-center gap-2 mb-3">
                        <i class="fas fa-bullseye text-neon-pink text-xl"></i>
                        <label class="text-base font-bold text-white uppercase tracking-wider">
                          Target Goal Time
                        </label>
                      </div>
                      <input
                        type="time"
                        id="goal-performance"
                        step="1"
                        class="w-full p-4 rounded-xl text-white text-2xl text-center font-bold focus:outline-none bg-black/50 border-2 border-white/20 focus:border-neon-pink focus:ring-4 focus:ring-neon-pink/20"
                        style="color-scheme: dark;"
                      />
                      <p class="text-xs text-slate-400 mt-3 text-center font-semibold">Your target to achieve</p>
                    </div>
                  </div>
                </div>

                <!-- Hidden inputs to store values for backward compatibility -->
                <input type="hidden" id="current-time" value="">
                <input type="hidden" id="goal-time" value="">
              </div>
            </div>
          </div>

          <!-- Step 3: Equipment -->
          <div class="wizard-step" data-step="3">
            <div class="max-w-4xl mx-auto bg-black/30 backdrop-blur-xl rounded-3xl border border-white/10 p-12 card-glow fade-in">
              <h2 class="text-3xl font-black text-white mb-3 flex items-center">
                <i class="fas fa-gears text-neon-pink mr-3"></i>
                Training Equipment
              </h2>
              <p class="text-slate-400 mb-10">Select the equipment you have access to for better training recommendations</p>
              
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="equipment-card rounded-2xl p-6 text-center" data-equipment="gps-watch">
                  <i class="fas fa-clock text-4xl text-cyan-400 mb-3"></i>
                  <p class="text-base font-bold mb-1">GPS Watch</p>
                  <p class="text-xs text-slate-400">Track distance & pace</p>
                </div>
                <div class="equipment-card rounded-2xl p-6 text-center" data-equipment="heart-rate-monitor">
                  <i class="fas fa-heartbeat text-4xl text-red-400 mb-3"></i>
                  <p class="text-base font-bold mb-1">Heart Rate Monitor</p>
                  <p class="text-xs text-slate-400">Track Heart Rate</p>
                </div>
                <div class="equipment-card rounded-2xl p-6 text-center" data-equipment="power-meter">
                  <i class="fas fa-gauge-high text-4xl text-neon-pink mb-3"></i>
                  <p class="text-base font-bold mb-1">Power Meter</p>
                  <p class="text-xs text-slate-400">Track Wattage</p>
                </div>
              </div>
              <p class="text-sm text-slate-500 mt-6 text-center">
                <i class="fas fa-info-circle mr-2"></i>
                Select all that apply - this helps us create more accurate training zones and workouts
              </p>
            </div>
          </div>

          <!-- Step 4: Schedule -->
          <div class="wizard-step" data-step="4">
            <div class="max-w-4xl mx-auto bg-black/30 backdrop-blur-xl rounded-3xl border border-white/10 p-12 card-glow fade-in">
              <h2 class="text-3xl font-black text-white mb-3 flex items-center">
                <i class="fas fa-calendar-days text-neon-pink mr-3"></i>
                Plan Your Schedule
              </h2>
              <p class="text-slate-400 mb-10">How much time can you commit to training?</p>
              
              <div class="space-y-10">
                <!-- Date Selection Mode -->
                <div>
                  <label class="block text-base font-bold text-white uppercase tracking-wider mb-4">
                    Choose Your Planning Method
                  </label>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="date-mode-card active" data-mode="start" onclick="selectDateMode('start')">
                      <i class="fas fa-calendar-check text-3xl text-neon-pink mb-2"></i>
                      <p class="font-bold text-base">Start Date</p>
                      <p class="text-xs text-slate-400 mt-1">I know when I want to start</p>
                    </div>
                    <div class="date-mode-card" data-mode="race" onclick="selectDateMode('race')">
                      <i class="fas fa-flag-checkered text-3xl text-neon-indigo mb-2"></i>
                      <p class="font-bold text-base">Race Day</p>
                      <p class="text-xs text-slate-400 mt-1">Calculate backwards from race</p>
                    </div>
                  </div>
                </div>

                <!-- Date Input -->
                <div>
                  <label class="block text-base font-bold text-white uppercase tracking-wider mb-3" id="date-label">
                    Select Start Date
                  </label>
                  <input
                    type="date"
                    id="plan-date"
                    class="w-full p-4 rounded-2xl text-white text-lg focus:outline-none"
                  />
                  <p class="text-sm text-slate-500 mt-2" id="date-helper">Choose when you want to begin training</p>
                </div>

                <!-- Plan Duration -->
                <div>
                  <div class="flex justify-between items-center mb-4">
                    <label class="text-base font-bold text-white uppercase tracking-wider">
                      Plan Duration
                    </label>
                    <span id="duration-display" class="text-2xl text-neon-pink font-black">8 weeks</span>
                  </div>
                  <input
                    type="range"
                    id="duration-slider"
                    min="4"
                    max="26"
                    value="8"
                    class="w-full"
                  />
                  <div class="flex justify-between text-sm text-slate-500 mt-2">
                    <span>4 weeks</span>
                    <span>12 weeks</span>
                    <span>20 weeks</span>
                    <span>26 weeks</span>
                  </div>
                </div>

                <!-- Sessions Per Week -->
                <div>
                  <div class="flex justify-between items-center mb-4">
                    <label class="text-base font-bold text-white uppercase tracking-wider">
                      Training Sessions Per Week
                    </label>
                    <span id="sessions-display" class="text-2xl text-neon-pink font-black">4 sessions</span>
                  </div>
                  <input
                    type="range"
                    id="sessions-slider"
                    min="1"
                    max="10"
                    value="4"
                    class="w-full"
                  />
                  <div class="flex justify-between text-sm text-slate-500 mt-2">
                    <span>1</span>
                    <span>3</span>
                    <span>5</span>
                    <span>7</span>
                    <span>10</span>
                  </div>
                </div>

                <!-- Available Time -->
                <div>
                  <div class="flex justify-between items-center mb-4">
                    <label class="text-base font-bold text-white uppercase tracking-wider">
                      Available Training Time Per Week
                    </label>
                    <span id="time-display" class="text-2xl text-neon-pink font-black">6 hours</span>
                  </div>
                  <input
                    type="range"
                    id="time-slider"
                    min="2"
                    max="20"
                    value="6"
                    class="w-full"
                  />
                  <div class="flex justify-between text-sm text-slate-500 mt-2">
                    <span>2h</span>
                    <span>8h</span>
                    <span>14h</span>
                    <span>20h</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 5: Review -->
          <div class="wizard-step" data-step="5">
            <div class="max-w-4xl mx-auto bg-black/30 backdrop-blur-xl rounded-3xl border border-white/10 p-12 card-glow fade-in">
              <h2 class="text-3xl font-black text-white mb-3 flex items-center">
                <i class="fas fa-check text-neon-pink mr-3"></i>
                Review & Customize
              </h2>
              <p class="text-slate-400 mb-10">Add any final details to personalize your plan</p>
              
              <div class="space-y-6">
                <!-- Summary -->
                <div class="bg-gradient-to-br from-neon-pink/10 to-neon-indigo/10 rounded-2xl p-6 border border-white/10">
                  <h3 class="text-lg font-bold text-white mb-4 uppercase tracking-wider">Your Plan Summary</h3>
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span class="text-slate-400">Plan Name:</span>
                      <span class="text-white font-semibold ml-2" id="summary-name">-</span>
                    </div>
                    <div>
                      <span class="text-slate-400">Sport:</span>
                      <span class="text-white font-semibold ml-2" id="summary-sport">-</span>
                    </div>
                    <div>
                      <span class="text-slate-400">Current:</span>
                      <span class="text-white font-semibold ml-2" id="summary-current">-</span>
                    </div>
                    <div>
                      <span class="text-slate-400">Goal:</span>
                      <span class="text-white font-semibold ml-2" id="summary-goal">-</span>
                    </div>
                    <div>
                      <span class="text-slate-400">Duration:</span>
                      <span class="text-white font-semibold ml-2" id="summary-duration">-</span>
                    </div>
                    <div>
                      <span class="text-slate-400">Frequency:</span>
                      <span class="text-white font-semibold ml-2" id="summary-sessions">-</span>
                    </div>
                    <div class="col-span-2">
                      <span class="text-slate-400">Equipment:</span>
                      <span class="text-white font-semibold ml-2" id="summary-equipment">None selected</span>
                    </div>
                  </div>
                </div>

                <!-- Additional Info -->
                <div>
                  <label class="block text-sm font-bold text-white uppercase tracking-wider mb-3">
                    Additional Information (Optional)
                  </label>
                  <textarea
                    id="additional-info"
                    placeholder="Any injuries, training preferences, race dates, or specific constraints..."
                    rows="4"
                    class="w-full p-4 rounded-2xl text-white text-base focus:outline-none resize-none"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-end gap-4 max-w-4xl mx-auto w-full fade-in">
          <button
            id="prev-btn"
            class="secondary-button px-6 py-3 rounded-xl font-semibold uppercase tracking-wider flex items-center justify-center text-sm"
            style="display: none;"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            <span>Back</span>
          </button>
          <button
            id="next-btn"
            class="gradient-button px-6 py-3 rounded-xl font-semibold uppercase tracking-wider disabled:opacity-50 flex items-center text-sm"
          >
            <span>Next Step</span>
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
          <button
            id="create-plan-btn"
            class="gradient-button px-8 py-3 rounded-xl font-semibold uppercase tracking-wider flex items-center text-sm"
            style="display: none;"
          >
            <span>Create My Plan</span>
            <i class="fas fa-magic ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content (Hidden until plan is created) -->
    <div id="main-content" class="hidden h-screen flex flex-col">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 pb-4 border-b border-white/10">
        <div class="flex-grow">
          <h1 id="plan-title" class="text-3xl font-black text-white uppercase tracking-wider">
            <i class="fa-solid fa-calendar-days text-neon-pink mr-2"></i>
            Your Training Plan
          </h1>
          <p id="plan-summary" class="text-slate-400 text-sm mt-1"></p>
        </div>
        <div class="flex gap-3">
          <button
            id="new-plan-btn"
            class="px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 hover:border-neon-pink/50 hover:bg-neon-pink/10 transition text-sm font-semibold"
          >
            <i class="fas fa-plus mr-2"></i>New Plan
          </button>
          <a
            href="user.html"
            class="px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 hover:border-neon-pink/50 hover:bg-neon-pink/10 transition text-sm font-semibold"
          >
            <i class="fas fa-arrow-left mr-2"></i>Dashboard
          </a>
        </div>
      </div>

      <!-- Toggle View Buttons -->
      <div class="flex gap-3 px-6 pt-4 pb-3">
        <button
          id="text-view-btn"
          class="px-5 py-2.5 rounded-xl bg-neon-pink/20 border border-neon-pink/40 font-semibold text-sm transition hover:bg-neon-pink/30"
        >
          <i class="fas fa-align-left mr-2"></i>Text View
        </button>
        <button
          id="calendar-view-btn"
          class="px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 hover:border-neon-pink/50 transition font-semibold text-sm"
        >
          <i class="fas fa-calendar mr-2"></i>Calendar View
        </button>
      </div>

      <!-- Plan Display -->
      <div class="flex-grow overflow-hidden px-6 pb-6">
        <div class="h-full bg-black/20 rounded-2xl border border-white/10 overflow-y-auto">
          <div id="text-view" class="plan-content p-6"></div>
          <div id="calendar-view" class="hidden p-6"></div>
        </div>
      </div>
    </div>

    <script src="./parser-utils.js"></script>
    <script src="./export-utils.js"></script>

    <script>
      let selectedSport = null;
      let trainingPlanData = null;
      let currentStep = 1;
      let highestStepReached = 1; // Track the highest step user has reached
      const totalSteps = 5;
      let dateMode = 'start'; // 'start' or 'race'
      let selectedEquipment = [];
      let currentCalendarMonth = new Date();
      let planStartDate = null;
      let planEndDate = null;

      // Initialize wizard
      function initWizard() {
        updateStepUI();
        updateNavigationButtons();
        
        // Set default date to today
        const today = new Date();
        document.getElementById('plan-date').valueAsDate = today;
      }

      // Date mode selection
      function selectDateMode(mode) {
        dateMode = mode;
        document.querySelectorAll('.date-mode-card').forEach(card => {
          card.classList.remove('active');
        });
        document.querySelector(`.date-mode-card[data-mode="${mode}"]`).classList.add('active');
        
        const dateLabel = document.getElementById('date-label');
        const dateHelper = document.getElementById('date-helper');
        
        if (mode === 'start') {
          dateLabel.textContent = 'Select Start Date';
          dateHelper.textContent = 'Choose when you want to begin training';
        } else {
          dateLabel.textContent = 'Select Race Day';
          dateHelper.textContent = 'We\'ll calculate your training plan backwards';
        }
      }

      // Sport selection
      document.querySelectorAll('.sport-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('.sport-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedSport = card.dataset.sport;
          updateNavigationButtons();
        });
      });

      // Equipment selection (multi-select)
      document.querySelectorAll('.equipment-card').forEach(card => {
        card.addEventListener('click', () => {
          const equipment = card.dataset.equipment;
          
          if (card.classList.contains('selected')) {
            // Deselect
            card.classList.remove('selected');
            selectedEquipment = selectedEquipment.filter(e => e !== equipment);
          } else {
            // Select
            card.classList.add('selected');
            selectedEquipment.push(equipment);
          }
        });
      });

      // Goal selections
      let selectedDistance = null;

      // Distance selection
      document.querySelectorAll('.goal-distance-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('.goal-distance-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedDistance = card.dataset.distance;
          updateNavigationButtons();
        });
      });

      // Performance inputs
      const currentPerformanceInput = document.getElementById('current-performance');
      const goalPerformanceInput = document.getElementById('goal-performance');

      currentPerformanceInput.addEventListener('input', () => {
        updateGoalInputs();
        updateNavigationButtons();
      });

      goalPerformanceInput.addEventListener('input', () => {
        updateGoalInputs();
        updateNavigationButtons();
      });

      // Update hidden inputs based on selections
      function updateGoalInputs() {
        const currentPerf = currentPerformanceInput.value.trim();
        const goalPerf = goalPerformanceInput.value.trim();

        const distanceNames = {
          '5k': '5K',
          '10k': '10K',
          'half-marathon': 'Half Marathon',
          'marathon': 'Marathon',
          '50k': '50K Ultra',
          '100k': '100K Ultra',
          'custom': 'Custom Distance'
        };

        if (selectedDistance && currentPerf && goalPerf) {
          document.getElementById('current-time').value = 
            `${distanceNames[selectedDistance]} - Current: ${currentPerf}`;
          document.getElementById('goal-time').value = 
            `${distanceNames[selectedDistance]} - Goal: ${goalPerf}`;
        }
      }

      // Sliders
      const sessionsSlider = document.getElementById('sessions-slider');
      const sessionsDisplay = document.getElementById('sessions-display');
      sessionsSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        sessionsDisplay.textContent = `${value} session${value > 1 ? 's' : ''}`;
        updateSliderFill(sessionsSlider);
      });

      const durationSlider = document.getElementById('duration-slider');
      const durationDisplay = document.getElementById('duration-display');
      durationSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        durationDisplay.textContent = `${value} week${value > 1 ? 's' : ''}`;
        updateSliderFill(durationSlider);
      });

      const timeSlider = document.getElementById('time-slider');
      const timeDisplay = document.getElementById('time-display');
      timeSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        timeDisplay.textContent = `${value} hour${value > 1 ? 's' : ''}`;
        updateSliderFill(timeSlider);
      });

      // Update slider fill visual
      function updateSliderFill(slider) {
        const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.background = `linear-gradient(to right, #ec4899 0%, #4f46e5 ${value}%, rgba(255, 255, 255, 0.1) ${value}%, rgba(255, 255, 255, 0.1) 100%)`;
      }

      // Initialize slider fills
      updateSliderFill(sessionsSlider);
      updateSliderFill(durationSlider);
      updateSliderFill(timeSlider);

      // Navigation
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const createBtn = document.getElementById('create-plan-btn');

      nextBtn.addEventListener('click', () => {
        if (validateStep(currentStep)) {
          goToStep(currentStep + 1);
        }
      });

      prevBtn.addEventListener('click', () => {
        goToStep(currentStep - 1);
      });

      // Try to go to step only if it's accessible
      function tryGoToStep(step) {
        // Only allow going to steps that have been reached before or are the current step
        if (step <= highestStepReached) {
          goToStep(step);
        }
      }

      function goToStep(step) {
        if (step < 1 || step > totalSteps) return;

        const direction = step > currentStep ? 'forward' : 'backward';
        
        // Update highest step reached if moving forward
        if (step > highestStepReached) {
          highestStepReached = step;
        }
        
        // Scroll wizard container to top
        const stepsContainer = document.querySelector('.overflow-y-auto.mb-6');
        if (stepsContainer) {
          stepsContainer.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Animate out current step
        const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
        currentStepEl.classList.add(direction === 'forward' ? 'exiting' : 'exiting-reverse');
        
        setTimeout(() => {
          currentStepEl.classList.remove('active', 'exiting', 'exiting-reverse');
          
          // Animate in new step
          currentStep = step;
          const newStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
          if (direction === 'backward') {
            newStepEl.classList.add('entering-reverse');
          }
          newStepEl.classList.add('active');
          
          // Remove entering-reverse class after animation
          setTimeout(() => {
            newStepEl.classList.remove('entering-reverse');
          }, 600);
          
          updateStepUI();
          updateNavigationButtons();
          
          if (currentStep === 5) {
            updateSummary();
          }
        }, 300);
      }

      function updateStepUI() {
        // Update progress bar - fix calculation to start at 0% for step 1
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;

        // Update step indicators
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
          const step = index + 1;
          const container = indicator.closest('.step-container');
          const label = indicator.nextElementSibling;
          
          indicator.classList.remove('active', 'completed');
          label.classList.remove('text-white', 'text-slate-400');
          
          // Update cursor style based on accessibility
          if (container) {
            if (step <= highestStepReached) {
              container.style.cursor = 'pointer';
              container.style.opacity = '1';
            } else {
              container.style.cursor = 'not-allowed';
              container.style.opacity = '0.5';
            }
          }
          
          if (step < currentStep) {
            indicator.classList.add('completed');
            indicator.innerHTML = '<i class="fas fa-check text-sm"></i>';
            label.classList.add('text-white');
          } else if (step === currentStep) {
            indicator.classList.add('active');
            label.classList.add('text-white');
          } else {
            label.classList.add('text-slate-400');
          }
        });
      }

      function updateNavigationButtons() {
        // Show/hide prev button
        prevBtn.style.display = currentStep === 1 ? 'none' : 'flex';
        
        // Show/hide next vs create button
        if (currentStep === totalSteps) {
          nextBtn.style.display = 'none';
          createBtn.style.display = 'flex';
        } else {
          nextBtn.style.display = 'flex';
          createBtn.style.display = 'none';
        }

        // Enable/disable next button based on validation
        nextBtn.disabled = !canProceed(currentStep);
      }

      function canProceed(step) {
        switch(step) {
          case 1:
            const planName = document.getElementById('plan-name').value.trim();
            return selectedSport !== null && planName !== '';
          case 2:
            const currentPerf = document.getElementById('current-performance').value.trim();
            const goalPerf = document.getElementById('goal-performance').value.trim();
            return selectedDistance !== null && currentPerf !== '' && goalPerf !== '';
          case 3:
            return true; // Equipment is optional
          case 4:
            return true; // Sliders always have values
          default:
            return false;
        }
      }

      function validateStep(step) {
        if (!canProceed(step)) {
          let message = '';
          switch(step) {
            case 1:
              const planName = document.getElementById('plan-name').value.trim();
              if (!planName) {
                message = 'Please enter a plan name to continue';
              } else if (!selectedSport) {
                message = 'Please select a sport to continue';
              }
              break;
            case 2:
              message = 'Please fill in both current and goal performance';
              break;
          }
          if (message) {
            showNotification(message, 'error');
          }
          return false;
        }
        return true;
      }

      function updateSummary() {
        const planName = document.getElementById('plan-name').value.trim() || 'My Training Plan';
        const sport = selectedSport ? selectedSport.charAt(0).toUpperCase() + selectedSport.slice(1) : '-';
        const current = document.getElementById('current-time').value.trim();
        const goal = document.getElementById('goal-time').value.trim();
        const duration = durationSlider.value;
        const sessions = sessionsSlider.value;
        
        // Format equipment list
        const equipmentText = selectedEquipment.length > 0 
          ? selectedEquipment.map(e => e.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')).join(', ')
          : 'None selected';

        document.getElementById('summary-name').textContent = planName;
        document.getElementById('summary-sport').textContent = sport;
        document.getElementById('summary-current').textContent = current;
        document.getElementById('summary-goal').textContent = goal;
        document.getElementById('summary-duration').textContent = `${duration} weeks`;
        document.getElementById('summary-sessions').textContent = `${sessions} sessions/week`;
        document.getElementById('summary-equipment').textContent = equipmentText;
      }

      function showNotification(message, type = 'info') {
        // Create toast container if it doesn't exist
        let container = document.querySelector('.toast-container');
        if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container';
          document.body.appendChild(container);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // Icon based on type
        const icons = {
          success: '<i class="fas fa-check-circle"></i>',
          error: '<i class="fas fa-exclamation-circle"></i>',
          info: '<i class="fas fa-info-circle"></i>'
        };
        
        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-message">${message}</div>
          </div>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => {
            toast.remove();
            if (container.children.length === 0) {
              container.remove();
            }
          }, 300);
        }, 4000);
      }

      // Watch for input changes to enable/disable next button
      document.getElementById('plan-name').addEventListener('input', updateNavigationButtons);

      // Create Plan Button
      createBtn.addEventListener('click', async () => {
        const planName = document.getElementById('plan-name').value.trim();
        const currentTime = document.getElementById('current-time').value.trim();
        const goalTime = document.getElementById('goal-time').value.trim();
        const sessions = sessionsSlider.value;
        const duration = durationSlider.value;
        const availableTime = `${timeSlider.value} hours`;
        const additionalInfo = document.getElementById('additional-info').value.trim();

        // Build equipment string
        const equipmentStr = selectedEquipment.length > 0 
          ? `\n**Available Equipment:** ${selectedEquipment.map(e => e.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')).join(', ')}`
          : '';

        // Build the prompt
        const prompt = `Please create a personalized training plan with the following details:

**Sport:** ${selectedSport.charAt(0).toUpperCase() + selectedSport.slice(1)}
**Current Performance:** ${currentTime}
**Goal:** ${goalTime}
**Plan Duration:** ${duration} weeks
**Training Frequency:** ${sessions} sessions per week
**Available Training Time:** ${availableTime} per week${equipmentStr}${additionalInfo ? `\n**Additional Information:** ${additionalInfo}` : ''}

Please provide:
1. A structured ${duration}-week training plan
2. Week-by-week breakdown with specific workouts
3. For EVERY workout, include ALL of these details:
   - Clear, descriptive workout name/type (e.g., "Easy Run", "Tempo Run", "Interval Training")
   - Distance in kilometers (e.g., "10km" or "8.5km")
   - Heart rate range (e.g., "HR: 130-145 bpm" or "Zone 2" or "60-70% max HR")
   - Target pace (e.g., "5:30/km" or "easy pace" or "moderate pace")
4. ${selectedEquipment.includes('power-meter') ? 'Include power-based training zones and targets where applicable.' : ''}
5. ${selectedEquipment.includes('heart-rate-monitor') ? 'Use heart rate zones for intensity guidance.' : 'Describe intensity using RPE (Rate of Perceived Exertion) if no heart rate monitor available.'}
6. Include rest and recovery days
7. Progressive structure that builds toward the goal
8. Tips for successful training

Format each workout clearly with all stats. Example format:
**Easy Run: 10km  HR: 130-145 bpm  Pace: 5:45/km** - Description of the workout

Format the plan clearly with headers for each week and day.`;

        // Show loading state
        const createBtnIcon = createBtn.querySelector('i');
        const createBtnText = createBtn.querySelector('span');
        
        // Replace icon with spinner
        createBtnIcon.outerHTML = '<svg class="animate-spin h-5 w-5 text-white ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        
        // Animate loading text
        const loadingTexts = [
          'Analyzing your goals...',
          'Building your plan...',
          'Optimizing schedule...',
          'Almost ready...'
        ];
        let loadingStep = 0;
        createBtnText.textContent = loadingTexts[0];
        
        const loadingInterval = setInterval(() => {
          loadingStep++;
          if (loadingStep < loadingTexts.length) {
            createBtnText.textContent = loadingTexts[loadingStep];
          }
        }, 2500);
        
        createBtn.disabled = true;

        try {
          const response = await fetch('http://127.0.0.1:5500/api/training-plan', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: prompt }),
          });

          if (!response.ok) {
            throw new Error('Launch app.py');
          }

          const data = await response.json();
          trainingPlanData = data.response;

          // Hide wizard with fade out
          const wizardOverlay = document.getElementById('wizard-overlay');
          wizardOverlay.style.opacity = '0';
          wizardOverlay.style.transition = 'opacity 0.4s ease-out';
          
          setTimeout(() => {
            wizardOverlay.classList.add('hidden');
            wizardOverlay.style.opacity = '';
            wizardOverlay.style.transition = '';
            
            // Show plan with celebration animation
            const mainContent = document.getElementById('main-content');
            mainContent.classList.remove('hidden');
            mainContent.classList.add('plan-reveal');
            
            // Display plan
            displayPlan(trainingPlanData);
            
            // Show success notification
            setTimeout(() => {
              showNotification(' Your training plan is ready!', 'success');
            }, 500);
            
            // Remove animation class after it completes
            setTimeout(() => {
              mainContent.classList.remove('plan-reveal');
            }, 800);
          }, 400);

          // Set title and summary
          const titleElement = document.getElementById('plan-title');
          if (planName) {
            titleElement.innerHTML = `<i class="fa-solid fa-calendar-days text-neon-pink mr-2"></i>${planName}`;
          } else {
            titleElement.innerHTML = `<i class="fa-solid fa-calendar-days text-neon-pink mr-2"></i>Your Training Plan`;
          }
          
          document.getElementById('plan-summary').textContent = 
            `${selectedSport.charAt(0).toUpperCase() + selectedSport.slice(1)}  ${duration} weeks  ${sessions} sessions/week  ${availableTime}`;

        } catch (error) {
          clearInterval(loadingInterval);
          showNotification('Error: Please make sure app.py is running', 'error');
          createBtn.innerHTML = '<span>Create My Plan</span><i class="fas fa-magic ml-2"></i>';
          createBtn.disabled = false;
        }
      });

      // Display plan in text view with beautiful card layout
      function displayPlan(planData) {
        console.log('displayPlan called with:', planData);
        const textView = document.getElementById('text-view');
        textView.innerHTML = '';
        
        // Check if we have structured workout data
        if (planData && planData.workouts && Array.isArray(planData.workouts)) {
          console.log('Using structured workout format, count:', planData.workouts.length);
          // New structured format from API
          const parsedPlan = convertWorkoutsToWeeks(planData.workouts);
          console.log('Parsed plan for rendering:', parsedPlan);
          renderStructuredPlan(parsedPlan, textView);
        } else if (typeof planData === 'string') {
          console.log('Using legacy string format');
          // Legacy text format - parse it
          const parsedPlan = parsePlanText(planData);
          if (parsedPlan.weeks && parsedPlan.weeks.length > 0) {
            renderStructuredPlan(parsedPlan, textView);
          } else {
            renderBasicPlan(planData, textView);
          }
        } else {
          console.log('Unknown plan data format:', typeof planData);
          // Fallback
          textView.innerHTML = '<p class="text-slate-400">No training plan data available</p>';
        }
      }

      // Convert structured workouts array to week-based format
      function convertWorkoutsToWeeks(workouts) {
        console.log('Converting workouts to weeks:', workouts);
        const plan = { intro: '', weeks: [], tips: '' };
        const weekMap = new Map();
        
        // Group workouts by week
        workouts.forEach(workout => {
          if (!weekMap.has(workout.week_number)) {
            weekMap.set(workout.week_number, {
              number: workout.week_number,
              days: [],
              description: ''
            });
          }
          
          const week = weekMap.get(workout.week_number);
          week.days.push({
            name: workout.day_of_week,
            workouts: [{
              type: workout.name,
              details: workout.detail,
              distance: workout.distance,
              duration: workout.duration,
              minHr: workout.min_heart_rate,
              maxHr: workout.max_heart_rate,
              pace: workout.pace,
              intensity: workout.difficulty
            }]
          });
        });
        
        // Convert map to array and sort by week number
        plan.weeks = Array.from(weekMap.values()).sort((a, b) => a.number - b.number);
        
        console.log('Converted plan:', plan);
        return plan;
      }

      // NOTE: parsePlanText, extractWorkoutName, parseWorkoutDetails, detectIntensity, 
      // extractWorkoutStats, and mapWorkoutsToCalendar are now defined in parser-utils.js
      // The functions below are kept for backwards compatibility but will be overridden
      
      function parsePlanText(text) {
        const plan = { intro: '', weeks: [], tips: '' };
        const lines = text.split('\n');
        let currentWeek = null;
        let currentDay = null;
        let currentSection = 'intro';
        
        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          
          // Check for week header
          const weekMatch = line.match(/\*\*Week\s+(\d+)/i);
          if (weekMatch) {
            if (currentWeek) plan.weeks.push(currentWeek);
            currentWeek = { number: weekMatch[1], days: [], description: '' };
            currentDay = null;
            currentSection = 'week';
            continue;
          }
          
          // Check for day header
          const dayMatch = line.match(/\*\*(Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s*(\d*)/i);
          if (dayMatch && currentWeek) {
            if (currentDay) currentWeek.days.push(currentDay);
            currentDay = { name: line.replace(/\*\*/g, ''), workouts: [] };
            continue;
          }
          
          // Check for tips section
          if (line.match(/\*\*Tips|\*\*Advice|\*\*Notes|\*\*Important/i)) {
            if (currentWeek) plan.weeks.push(currentWeek);
            currentWeek = null;
            currentDay = null;
            currentSection = 'tips';
            continue;
          }
          
          // Add content to appropriate section
          if (currentSection === 'intro' && !currentWeek) {
            plan.intro += line + ' ';
          } else if (currentDay) {
            currentDay.workouts.push(line);
          } else if (currentWeek) {
            currentWeek.description += line + ' ';
          } else if (currentSection === 'tips') {
            plan.tips += line + ' ';
          }
        }
        
        if (currentDay && currentWeek) currentWeek.days.push(currentDay);
        if (currentWeek) plan.weeks.push(currentWeek);
        
        return plan;
      }

      function renderStructuredPlan(plan, container) {
        console.log('Rendering structured plan:', plan);
        
        // Render intro if exists
        if (plan.intro && plan.intro.trim()) {
          const introDiv = document.createElement('div');
          introDiv.className = 'plan-section-header mb-6';
          introDiv.innerHTML = '<h2><i class="fas fa-bullseye mr-2"></i>Your Training Plan Overview</h2><p class="text-slate-300 text-sm mt-2 leading-relaxed">' + formatText(plan.intro) + '</p>';
          container.appendChild(introDiv);
        }
        
        // Render weeks
        plan.weeks.forEach((week, index) => {
          const weekCard = document.createElement('div');
          weekCard.className = 'week-card';
          
          // Build days HTML
          let daysHtml = '';
          week.days.forEach(day => {
            let workoutsHtml = '';
            day.workouts.forEach(workout => {
              if (typeof workout === 'object' && workout !== null) {
                const intensity = workout.intensity || workout.difficulty || detectIntensity(workout.type || '');
                const stats = [];
                if (workout.distance) stats.push(workout.distance + ' km');
                if (workout.duration) stats.push(workout.duration + ' min');
                if (workout.minHr && workout.maxHr) stats.push('HR: ' + workout.minHr + '-' + workout.maxHr + ' bpm');
                if (workout.pace) {
                  if (typeof workout.pace === 'number') {
                    const mins = Math.floor(workout.pace);
                    const secs = Math.round((workout.pace - mins) * 60);
                    stats.push(mins + ':' + secs.toString().padStart(2, '0') + '/km');
                  } else {
                    stats.push(workout.pace + '/km');
                  }
                }
                
                workoutsHtml += '<div class="workout-detail-row">' +
                  '<i class="fas fa-circle text-xs workout-icon"></i>' +
                  '<div class="flex-grow">' +
                  '<span class="text-white font-semibold">' + (workout.type || workout.name || 'Workout') + '</span>' +
                  (stats.length > 0 ? '<span class="text-slate-400 ml-2">' + stats.join('  ') + '</span>' : '') +
                  (workout.details ? '<p class="text-slate-400 text-sm mt-1">' + workout.details + '</p>' : '') +
                  '</div>' +
                  (intensity ? '<span class="workout-type-badge workout-type-' + intensity.toLowerCase() + '">' + intensity + '</span>' : '') +
                  '</div>';
              } else {
                const intensity = detectIntensity(workout);
                workoutsHtml += '<div class="workout-detail-row">' +
                  '<i class="fas fa-circle text-xs workout-icon"></i>' +
                  '<span class="text-slate-300 flex-grow">' + formatText(workout) + '</span>' +
                  (intensity ? '<span class="workout-type-badge workout-type-' + intensity + '">' + intensity + '</span>' : '') +
                  '</div>';
              }
            });
            
            daysHtml += '<div class="workout-card">' +
              '<h4 class="text-white font-bold text-base mb-3 flex items-center gap-2">' +
              '<i class="fas fa-calendar-day text-neon-pink"></i>' +
              day.name.replace(/\*\*/g, '') +
              '</h4>' +
              '<div class="space-y-2 pl-7">' + workoutsHtml + '</div>' +
              '</div>';
          });
          
          weekCard.innerHTML = '<div class="flex items-center justify-between px-6 py-4 cursor-pointer" onclick="toggleWeek(this)">' +
            '<div class="flex items-center gap-4">' +
            '<span class="week-badge">Week ' + week.number + '</span>' +
            '<div>' +
            '<h3 class="text-white font-bold text-lg">Week ' + week.number + '</h3>' +
            (week.description ? '<p class="text-slate-400 text-sm mt-1">' + formatText(week.description).substring(0, 100) + '...</p>' : '') +
            '</div>' +
            '</div>' +
            '<div class="flex items-center gap-3">' +
            '<span class="text-slate-400 text-sm">' + week.days.length + ' days</span>' +
            '<i class="fas fa-chevron-down week-chevron text-lg"></i>' +
            '</div>' +
            '</div>' +
            '<div class="week-content">' +
            (week.description ? '<div class="mb-4 p-4 bg-black/20 rounded-lg border border-white/5"><p class="text-slate-300 text-sm leading-relaxed">' + formatText(week.description) + '</p></div>' : '') +
            '<div class="space-y-3">' + daysHtml + '</div>' +
            '</div>';
          
          container.appendChild(weekCard);
        });
      }

      function renderBasicPlan(text, container) {
        const formattedDiv = document.createElement('div');
        formattedDiv.className = 'text-slate-300 leading-relaxed space-y-4';
        formattedDiv.innerHTML = formatText(text);
        container.appendChild(formattedDiv);
      }

      function formatText(text) {
        return text
          .replace(/\*\*(.+?)\*\*/g, '<strong class="text-white font-bold">$1</strong>')
          .replace(/\n/g, '<br>');
      }

      function detectIntensity(workoutItem) {
        // Handle null/undefined
        if (!workoutItem) return null;
        
        // Handle object format (structured data)
        if (typeof workoutItem === 'object') {
          // Check for explicit difficulty/intensity fields first
          if (workoutItem.intensity) return workoutItem.intensity.toLowerCase();
          if (workoutItem.difficulty) return workoutItem.difficulty.toLowerCase();
          
          // Fall back to checking name/type text
          const text = (workoutItem.name || workoutItem.type || '').toLowerCase();
          if (text.includes('easy') || text.includes('recovery') || text.includes('light')) return 'easy';
          if (text.includes('hard') || text.includes('intense') || text.includes('vigorous')) return 'hard';
          if (text.includes('moderate') || text.includes('steady') || text.includes('tempo')) return 'moderate';
          if (text.includes('rest') || text.includes('off')) return 'recovery';
          return null;
        }
        
        // Handle string format (legacy)
        const lower = workoutItem.toLowerCase();
        if (lower.includes('easy') || lower.includes('recovery') || lower.includes('light')) return 'easy';
        if (lower.includes('hard') || lower.includes('intense') || lower.includes('vigorous')) return 'hard';
        if (lower.includes('moderate') || lower.includes('steady') || lower.includes('tempo')) return 'moderate';
        if (lower.includes('rest') || lower.includes('off')) return 'recovery';
        return null;
      }

      function toggleWeek(element) {
        const weekCard = element.parentElement;
        const content = weekCard.querySelector('.week-content');
        const chevron = weekCard.querySelector('.week-chevron');
        
        weekCard.classList.toggle('expanded');
        content.classList.toggle('expanded');
        chevron.classList.toggle('rotated');
      }

      // View toggle buttons
      document.getElementById('text-view-btn').addEventListener('click', () => {
        document.getElementById('text-view').classList.remove('hidden');
        document.getElementById('calendar-view').classList.add('hidden');
        document.getElementById('text-view-btn').classList.add('bg-neon-pink/20', 'border-neon-pink/40');
        document.getElementById('text-view-btn').classList.remove('bg-white/5', 'border-white/10');
        document.getElementById('calendar-view-btn').classList.remove('bg-neon-pink/20', 'border-neon-pink/40');
        document.getElementById('calendar-view-btn').classList.add('bg-white/5', 'border-white/10');
      });

      document.getElementById('calendar-view-btn').addEventListener('click', () => {
        document.getElementById('text-view').classList.add('hidden');
        document.getElementById('calendar-view').classList.remove('hidden');
        document.getElementById('calendar-view-btn').classList.add('bg-neon-pink/20', 'border-neon-pink/40');
        document.getElementById('calendar-view-btn').classList.remove('bg-white/5', 'border-white/10');
        document.getElementById('text-view-btn').classList.remove('bg-neon-pink/20', 'border-neon-pink/40');
        document.getElementById('text-view-btn').classList.add('bg-white/5', 'border-white/10');
        
        // Generate calendar view if not already done
        if (document.getElementById('calendar-view').innerHTML === '') {
          generateCalendarView(trainingPlanData);
        }
      });

      // Generate calendar view
      function generateCalendarView(planData) {
        const calendarView = document.getElementById('calendar-view');
        
        try {
          console.log('Generating calendar view with planData:', planData);
          
          if (!planData) {
            console.error('No plan data provided');
            calendarView.innerHTML = '<div class="text-center text-slate-400 p-8"><p class="text-lg">Unable to generate calendar view</p><p class="text-sm mt-2">Use Text View to see your complete training plan.</p></div>';
            return;
          }
          
          // Convert to structured format
          let parsedPlan;
          if (planData.workouts && Array.isArray(planData.workouts)) {
            // New structured format
            parsedPlan = convertWorkoutsToWeeks(planData.workouts);
          } else if (typeof planData === 'string') {
            // Legacy text format
            parsedPlan = parsePlanText(planData);
          } else {
            console.error('Invalid plan data format');
            calendarView.innerHTML = '<div class="text-center text-slate-400 p-8"><p class="text-lg">Unable to generate calendar view</p><p class="text-sm mt-2">Use Text View to see your complete training plan.</p></div>';
            return;
          }
          
          console.log('Parsed plan:', parsedPlan);
          console.log('Number of weeks:', parsedPlan.weeks ? parsedPlan.weeks.length : 0);
          
          if (!parsedPlan.weeks || parsedPlan.weeks.length === 0) {
            console.error('No weeks found in parsed plan');
            calendarView.innerHTML = '<div class="text-center text-slate-400 p-8"><p class="text-lg">Unable to generate calendar view</p><p class="text-sm mt-2">Use Text View to see your complete training plan.</p></div>';
            return;
          }

          // Calculate plan dates
          calculatePlanDates(parsedPlan);
          console.log('Plan dates:', { start: planStartDate, end: planEndDate });
          
          // Render calendar
          renderCalendar(calendarView, parsedPlan);
        } catch (error) {
          console.error('Calendar generation error:', error);
          console.error('Error stack:', error.stack);
          calendarView.innerHTML = '<div class="text-center text-slate-400 p-8"><p class="text-lg">Unable to generate calendar view</p><p class="text-sm mt-2">Use Text View to see your complete training plan.</p></div>';
        }
      }

      function calculatePlanDates(plan) {
        const planDateEl = document.getElementById('plan-date');
        const durationSliderEl = document.getElementById('duration-slider');
        
        // Use stored values or defaults
        const planDate = planDateEl ? planDateEl.value : null;
        const duration = durationSliderEl ? parseInt(durationSliderEl.value) : (plan.weeks ? plan.weeks.length : 12);
        
        if (dateMode === 'start') {
          planStartDate = planDate ? new Date(planDate) : new Date();
          planEndDate = new Date(planStartDate);
          planEndDate.setDate(planEndDate.getDate() + (duration * 7));
        } else {
          // Race day mode - calculate backwards
          planEndDate = planDate ? new Date(planDate) : new Date();
          planStartDate = new Date(planEndDate);
          planStartDate.setDate(planStartDate.getDate() - (duration * 7));
        }
        
        currentCalendarMonth = new Date(planStartDate);
      }

      function renderCalendar(container, plan) {
        container.innerHTML = '';
        
        // Create calendar navigation
        const calendarContainer = document.createElement('div');
        calendarContainer.className = 'calendar-container';
        
        const monthDisplay = document.createElement('div');
        monthDisplay.id = 'calendar-month-display';
        
        calendarContainer.appendChild(monthDisplay);
        container.appendChild(calendarContainer);
        
        updateCalendarMonth(plan);
      }

      function updateCalendarMonth(plan) {
        const display = document.getElementById('calendar-month-display');
        if (!display) return;
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        const today = new Date();
        const isCurrentMonth = currentCalendarMonth.getMonth() === today.getMonth() && 
                               currentCalendarMonth.getFullYear() === today.getFullYear();
        
        display.innerHTML = `
          <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changeMonth(-1)">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <div class="flex items-center gap-3">
              <h3 class="text-2xl font-black text-white">
                ${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}
              </h3>
              ${!isCurrentMonth ? `
                <button class="calendar-nav-btn" onclick="jumpToCurrentMonth()" title="Go to current month">
                  <i class="fas fa-calendar-day"></i> Today
                </button>
              ` : ''}
            </div>
            <div class="flex items-center gap-3">
              <div class="export-dropdown-container">
                <button class="calendar-nav-btn" onclick="toggleExportDropdown()" id="export-btn">
                  <i class="fas fa-download"></i> Export
                </button>
                <div class="export-dropdown" id="export-dropdown">
                  <div class="export-option" onclick="handleExportAsFIT()">
                    <i class="fas fa-file-code"></i>
                    <div class="export-option-text">
                      <div class="export-option-title">Export as FIT</div>
                      <div class="export-option-desc">Download Garmin FIT file</div>
                    </div>
                  </div>
                  <div class="export-option" onclick="handleExportAsICS()">
                    <i class="fas fa-file-export"></i>
                    <div class="export-option-text">
                      <div class="export-option-title">Export as ICS</div>
                      <div class="export-option-desc">Download calendar file</div>
                    </div>
                  </div>
                  <div class="export-option" onclick="syncToTrainingPeaks()">
                    <i class="fas fa-chart-line"></i>
                    <div class="export-option-text">
                      <div class="export-option-title">TrainingPeaks</div>
                      <div class="export-option-desc">Sync to TrainingPeaks</div>
                    </div>
                  </div>
                  <div class="export-option" onclick="syncToGarminConnect()">
                    <i class="fas fa-heartbeat"></i>
                    <div class="export-option-text">
                      <div class="export-option-title">Garmin Connect</div>
                      <div class="export-option-desc">Sync to Garmin Connect</div>
                    </div>
                  </div>
                </div>
              </div>
              <button class="calendar-nav-btn" onclick="changeMonth(1)">
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="calendar-grid">
            ${generateCalendarDays(plan)}
          </div>
        `;
      }

      function generateCalendarDays(plan) {
        const year = currentCalendarMonth.getFullYear();
        const month = currentCalendarMonth.getMonth();
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        // Get day of week (0=Sunday, 1=Monday, etc), then convert to Monday-first (0=Monday, 6=Sunday)
        const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // 0 = Monday
        
        // Weekday headers (Monday first)
        const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let html = weekdays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');
        html += '<div class="calendar-weekday">Week Summary</div>';
        
        // Map workouts to dates
        const workoutsByDate = mapWorkoutsToCalendar(plan);
        
        // Start from the first day of the month (no padding days from previous month)
        let currentDate = new Date(year, month, 1);
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDayOfWeek; i++) {
          html += '<div class="calendar-day-cell" style="opacity: 0; pointer-events: none;"></div>';
        }
        
        let weekNumber = 0;
        let daysInCurrentWeek = startingDayOfWeek;
        let weekDistance = 0;
        let weekDuration = 0;
        
        // Generate only days in the current month
        for (let dayOfMonth = 1; dayOfMonth <= daysInMonth; dayOfMonth++) {
          currentDate = new Date(year, month, dayOfMonth);
          const dateStr = currentDate.toISOString().split('T')[0];
          const workout = workoutsByDate[dateStr];
          
          if (workout) {
            const stats = extractWorkoutStats(workout);
            weekDistance += stats.distance;
            weekDuration += stats.duration;
          }
          
          const workoutName = workout ? extractWorkoutName(workout) : '';
          const intensity = (workout && workout[0]) ? detectIntensity(workout[0]) : null;
          
          // Check if this is today
          const today = new Date();
          const isToday = currentDate.getDate() === today.getDate() && 
                          currentDate.getMonth() === today.getMonth() && 
                          currentDate.getFullYear() === today.getFullYear();
          
          html += `
            <div class="calendar-day-cell ${workout ? 'has-workout' : ''} ${isToday ? 'today' : ''}"
                 ${workout ? `onclick="showWorkoutModal('${dateStr}', ${JSON.stringify(workout).replace(/"/g, '&quot;')})"` : ''}
                 ${workout ? `style="cursor: pointer;"` : ''}>
              <div class="calendar-day-number">${dayOfMonth}</div>
              ${workout ? `
                <div class="calendar-workout-name">${workoutName}</div>
                ${intensity ? `<div class="workout-type-badge workout-type-${intensity}" style="font-size: 8px; padding: 2px 6px; margin-top: 4px; display: inline-block;">${intensity}</div>` : ''}
              ` : '<div class="calendar-workout-name" style="color: #64748b; font-size: 10px; font-weight: 600;">Rest Day</div>'}
            </div>
          `;
          
          daysInCurrentWeek++;
          
          // End of week (Sunday)
          if (daysInCurrentWeek === 7) {
            weekNumber++;
            html += `
              <div class="week-summary">
                <div class="week-summary-title">Week ${weekNumber}</div>
                ${weekDistance > 0 ? `
                  <div class="week-summary-stat">
                    <span class="week-summary-label">Distance:</span>
                    <span class="week-summary-value">${weekDistance.toFixed(1)}km</span>
                  </div>
                ` : ''}
                ${weekDuration > 0 ? `
                  <div class="week-summary-stat">
                    <span class="week-summary-label">Duration:</span>
                    <span class="week-summary-value">${Math.round(weekDuration)}min</span>
                  </div>
                ` : ''}
                ${weekDistance === 0 && weekDuration === 0 ? `
                  <div class="week-summary-stat">
                    <span class="week-summary-label">Rest Week</span>
                  </div>
                ` : ''}
              </div>
            `;
            
            // Reset for next week
            daysInCurrentWeek = 0;
            weekDistance = 0;
            weekDuration = 0;
          }
        }
        
        // If there are remaining days in the last week, fill in days from next month
        if (daysInCurrentWeek > 0) {
          // Add days from next month to complete the week
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          
          for (let nextDayOfMonth = 1; daysInCurrentWeek < 7; nextDayOfMonth++) {
            currentDate = new Date(nextYear, nextMonth, nextDayOfMonth);
            const dateStr = currentDate.toISOString().split('T')[0];
            const workout = workoutsByDate[dateStr];
            
            if (workout) {
              const stats = extractWorkoutStats(workout);
              weekDistance += stats.distance;
              weekDuration += stats.duration;
            }
            
            const workoutName = workout ? extractWorkoutName(workout) : '';
            const intensity = (workout && workout[0]) ? detectIntensity(workout[0]) : null;
            
            // Check if this is today
            const today = new Date();
            const isToday = currentDate.getDate() === today.getDate() && 
                            currentDate.getMonth() === today.getMonth() && 
                            currentDate.getFullYear() === today.getFullYear();
            
            html += `
              <div class="calendar-day-cell ${workout ? 'has-workout' : ''} other-month ${isToday ? 'today' : ''}"
                   ${workout ? `onclick="showWorkoutModal('${dateStr}', ${JSON.stringify(workout).replace(/"/g, '&quot;')})"` : ''}
                   ${workout ? `style="cursor: pointer;"` : ''}>
                <div class="calendar-day-number">${nextDayOfMonth}</div>
                ${workout ? `
                  <div class="calendar-workout-name">${workoutName}</div>
                  ${intensity ? `<div class="workout-type-badge workout-type-${intensity}" style="font-size: 8px; padding: 2px 6px; margin-top: 4px; display: inline-block;">${intensity}</div>` : ''}
                ` : '<div class="calendar-workout-name" style="color: #64748b; font-size: 10px; font-weight: 600;">Rest Day</div>'}
              </div>
            `;
            
            daysInCurrentWeek++;
          }
          
          // Add week summary for the last week
          weekNumber++;
          html += `
            <div class="week-summary">
              <div class="week-summary-title">Week ${weekNumber}</div>
              ${weekDistance > 0 ? `
                <div class="week-summary-stat">
                  <span class="week-summary-label">Distance:</span>
                  <span class="week-summary-value">${weekDistance.toFixed(1)}km</span>
                </div>
              ` : ''}
              ${weekDuration > 0 ? `
                <div class="week-summary-stat">
                  <span class="week-summary-label">Duration:</span>
                  <span class="week-summary-value">${Math.round(weekDuration)}min</span>
                </div>
              ` : ''}
              ${weekDistance === 0 && weekDuration === 0 ? `
                <div class="week-summary-stat">
                  <span class="week-summary-label">Rest Week</span>
                </div>
              ` : ''}
            </div>
          `;
        }
        
        return html;
      }

      function mapWorkoutsToCalendar(plan) {
        const workoutMap = {};
        let currentDate = new Date(planStartDate);
        
        plan.weeks.forEach(week => {
          week.days.forEach(day => {
            const dateStr = currentDate.toISOString().split('T')[0];
            workoutMap[dateStr] = day.workouts;
            currentDate.setDate(currentDate.getDate() + 1);
          });
        });
        
        return workoutMap;
      }

      function extractWorkoutStats(workouts) {
        let distance = 0;
        let duration = 0;
        
        workouts.forEach(workout => {
          // Handle structured workout objects
          if (typeof workout === 'object' && workout !== null) {
            if (workout.distance) distance += workout.distance;
            if (workout.duration) duration += workout.duration;
            return;
          }
          
          // Handle string workouts (legacy)
          const lower = workout.toLowerCase();
          
          // Extract distance (km or miles)
          const distMatch = lower.match(/(\d+(?:\.\d+)?)\s*(?:km|k|miles?|mi)/i);
          if (distMatch) {
            distance += parseFloat(distMatch[1]);
          }
          
          // Extract duration (minutes or hours)
          const durMatch = lower.match(/(\d+)\s*(?:min|minutes?|hrs?|hours?)/i);
          if (durMatch) {
            const value = parseInt(durMatch[1]);
            if (lower.includes('hr') || lower.includes('hour')) {
              duration += value * 60;
            } else {
              duration += value;
            }
          }
        });
        
        return { distance, duration };
      }

      function changeMonth(direction) {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
        const parsedPlan = getParsedPlan(trainingPlanData);
        updateCalendarMonth(parsedPlan);
      }

      function jumpToCurrentMonth() {
        currentCalendarMonth = new Date();
        const parsedPlan = getParsedPlan(trainingPlanData);
        updateCalendarMonth(parsedPlan);
      }
      
      // Helper to parse plan data in either format
      function getParsedPlan(planData) {
        if (planData && planData.workouts && Array.isArray(planData.workouts)) {
          return convertWorkoutsToWeeks(planData.workouts);
        } else if (typeof planData === 'string') {
          return parsePlanText(planData);
        }
        return { intro: '', weeks: [], tips: '' };
      }

      // Export dropdown toggle
      function toggleExportDropdown() {
        const dropdown = document.getElementById('export-dropdown');
        dropdown.classList.toggle('active');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('export-dropdown');
        const exportBtn = document.getElementById('export-btn');
        if (dropdown && exportBtn && !dropdown.contains(e.target) && !exportBtn.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      });

      // Export functions - using utilities from export-utils.js
      function handleExportAsFIT() {
        document.getElementById('export-dropdown').classList.remove('active');
        
        if (!trainingPlanData) {
          showNotification('No training plan data available', 'error');
          return;
        }

        try {
          const planName = document.getElementById('plan-name').value.trim() || 'training-plan';
          exportAsFIT(trainingPlanData, planName, planStartDate, selectedSport, parsePlanText, parseWorkoutDetails);
          showNotification('FIT file downloaded successfully!', 'success');
        } catch (error) {
          console.error('Error generating FIT file:', error);
          showNotification('Error generating FIT file: ' + error.message, 'error');
        }
      }

      function handleExportAsICS() {
        document.getElementById('export-dropdown').classList.remove('active');
        
        if (!trainingPlanData) {
          showNotification('No training plan data available', 'error');
          return;
        }

        try {
          const planName = document.getElementById('plan-name').value.trim() || 'training-plan';
          exportAsICS(trainingPlanData, planName, planStartDate, parsePlanText, parseWorkoutDetails);
          showNotification('ICS file downloaded successfully!', 'success');
        } catch (error) {
          console.error('Error generating ICS file:', error);
          showNotification('Error generating ICS file: ' + error.message, 'error');
        }
      }

      function syncToTrainingPeaks() {
        document.getElementById('export-dropdown').classList.remove('active');
        showNotification('TrainingPeaks sync coming soon! This will sync your plan directly to TrainingPeaks.', 'info');
      }

      function syncToGarminConnect() {
        document.getElementById('export-dropdown').classList.remove('active');
        showNotification('Garmin Connect sync coming soon! This will sync your plan directly to Garmin Connect.', 'info');
      }

      function extractWorkoutName(workouts) {
        if (!workouts || workouts.length === 0) return '';
        
        // Take first workout
        let firstWorkout = workouts[0];
        
        // Handle object format
        if (typeof firstWorkout === 'object' && firstWorkout !== null) {
          return firstWorkout.type || firstWorkout.name || 'Workout';
        }
        
        // Handle string format (legacy)
        // Remove markdown asterisks
        firstWorkout = firstWorkout.replace(/\*\*/g, '').trim();
        
        // Remove any leading numbers/bullets (e.g., "1. ", "- ")
        firstWorkout = firstWorkout.replace(/^\d+\.?\s*[-]?\s*/, '');
        
        // Try to extract name before any stats
        // Pattern 1: Everything before colon
        let nameMatch = firstWorkout.match(/^([^:]+?)(?=:)/);
        if (nameMatch && nameMatch[1].trim().length > 3) {
          return nameMatch[1].trim();
        }
        
        // Pattern 2: Everything before first number (for distance/duration)
        nameMatch = firstWorkout.match(/^([A-Za-z\s]+?)(?=\s*\d)/);
        if (nameMatch && nameMatch[1].trim().length > 3) {
          return nameMatch[1].trim();
        }
        
        // Pattern 3: Everything before bullet point
        nameMatch = firstWorkout.match(/^([^]+?)(?=)/);
        if (nameMatch && nameMatch[1].trim().length > 3) {
          return nameMatch[1].trim();
        }
        
        // Fallback: take first 25 characters
        const name = firstWorkout.substring(0, 25).trim();
        return name + (firstWorkout.length > 25 ? '...' : '');
      }

      function parseWorkoutDetails(workout) {
        // Extract workout components
        const details = {
          name: '',
          distance: '',
          heartRate: '',
          pace: '',
          description: ''
        };
        
        console.log('Parsing workout:', workout); // Debug log
        
        // Handle object format (structured data from API)
        if (typeof workout === 'object' && workout !== null) {
          details.name = workout.name || workout.type || '';
          details.distance = workout.distance ? workout.distance + 'km' : '';
          // Check both naming conventions (min_heart_rate from API, minHr from convertWorkoutsToWeeks)
          const minHr = workout.min_heart_rate || workout.minHr;
          const maxHr = workout.max_heart_rate || workout.maxHr;
          if (minHr && maxHr) {
            details.heartRate = minHr + '-' + maxHr + ' bpm';
          } else if (workout.heart_rate) {
            details.heartRate = workout.heart_rate;
          }
          // Format pace as min/km if it's a number
          if (workout.pace) {
            if (typeof workout.pace === 'number') {
              const mins = Math.floor(workout.pace);
              const secs = Math.round((workout.pace - mins) * 60);
              details.pace = mins + ':' + secs.toString().padStart(2, '0') + '/km';
            } else {
              details.pace = workout.pace;
            }
          }
          details.description = workout.detail || workout.details || workout.description || '';
          console.log('Parsed structured details:', details);
          return details;
        }
        
        // Handle string format (legacy)
        // Extract name (before colon or bullet, or first meaningful text)
        const nameMatch = workout.match(/^([^:]+)/);
        if (nameMatch) {
          let name = nameMatch[1].replace(/\*\*/g, '').trim();
          // Remove any leading numbers or dashes
          name = name.replace(/^\d+\.?\s*[-]?\s*/, '');
          details.name = name;
        }
        
        // Extract distance - look for number followed by km/miles
        const distMatch = workout.match(/(\d+(?:\.\d+)?)\s*(km|k(?!\w)|kilometers?|miles?|mi(?!\w))/i);
        if (distMatch && distMatch[1] && distMatch[2]) {
          details.distance = `${distMatch[1]}${distMatch[2]}`;
          console.log('Found distance:', details.distance);
        }
        
        // Extract heart rate - look for HR:, Zone, or bpm range
        let hrMatch = workout.match(/HR[:\s]*([^\s,.]+(?:\s+[^\s,.]+)?)/i);
        if (!hrMatch) hrMatch = workout.match(/Heart\s*Rate[:\s]*([^\s,.]+(?:\s+[^\s,.]+)?)/i);
        if (!hrMatch) hrMatch = workout.match(/Zone\s*(\d+)/i);
        if (!hrMatch) hrMatch = workout.match(/(\d+\s*-\s*\d+)\s*bpm/i);
        if (!hrMatch) hrMatch = workout.match(/(\d+\s*-\s*\d+)\s*%/i);
        
        if (hrMatch && hrMatch[1]) {
          details.heartRate = hrMatch[1].trim();
          console.log('Found HR:', details.heartRate);
        } else if (hrMatch && hrMatch[0]) {
          details.heartRate = hrMatch[0].trim();
          console.log('Found HR:', details.heartRate);
        }
        
        // Extract pace - look for Pace:, @, or descriptive pace
        let paceMatch = workout.match(/Pace[:\s]*([^\s,.]+(?:\s+[^\s,.]+)?)/i);
        if (!paceMatch) paceMatch = workout.match(/@\s*([^\s,.]+(?:\s+[^\s,.]+)?)/i);
        if (!paceMatch) paceMatch = workout.match(/(\d+:\d+)\s*\/\s*km/i);
        if (!paceMatch) paceMatch = workout.match(/\bat\s+(?:an?\s+)?(easy|moderate|tempo|steady|recovery|comfortable|conversational)\s*pace/i);
        
        if (paceMatch && paceMatch[1]) {
          details.pace = paceMatch[1].trim();
          console.log('Found pace:', details.pace);
        } else if (paceMatch && paceMatch[0]) {
          details.pace = paceMatch[0].replace(/^at\s+(?:an?\s+)?/i, '').trim();
          console.log('Found pace:', details.pace);
        }
        
        // Get remaining description
        details.description = workout;
        
        console.log('Parsed details:', details); // Debug log
        return details;
      }

      function showWorkoutModal(dateStr, workouts) {
        // Parse the date
        const date = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);
        
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.className = 'workout-modal-overlay';
        overlay.onclick = (e) => {
          if (e.target === overlay) closeWorkoutModal();
        };
        
        // Create modal content
        const modal = document.createElement('div');
        modal.className = 'workout-modal';
        modal.onclick = (e) => e.stopPropagation();
        
        // Helper function to extract brief summary (first 1-2 sentences)
        const getBriefSummary = (workout) => {
          // Handle object format (structured data)
          if (typeof workout === 'object' && workout !== null) {
            return workout.detail || workout.details || workout.description || '';
          }
          
          // Handle string format (legacy)
          // Remove the stats that are already displayed
          let summary = workout.replace(/\*\*/g, '').trim();
          // Remove distance, HR, and pace info
          summary = summary.replace(/\d+(?:\.\d+)?\s*(?:km|k|kilometers?|miles?|mi)(?!\s*\/)/gi, '');
          summary = summary.replace(/(?:HR|Heart\s*Rate)[:\s]*[\d\-]+\s*(?:bpm|%)?/gi, '');
          summary = summary.replace(/Zone\s*\d+/gi, '');
          summary = summary.replace(/(?:Pace|@)[:\s]*[\d:]+\s*(?:\/|per)?\s*km/gi, '');
          summary = summary.replace(/[:\\-]+\s*/g, '').trim();
          // Get first 1-2 sentences
          const sentences = summary.match(/[^.!?]+[.!?]+/g);
          if (sentences && sentences.length > 0) {
            return sentences.slice(0, 2).join(' ').trim();
          }
          // Fallback to first 150 chars
          return summary.substring(0, 150).trim() + (summary.length > 150 ? '...' : '');
        };

        modal.innerHTML = `
          <button class="modal-close-btn" onclick="closeWorkoutModal()">
            <i class="fas fa-times"></i>
          </button>
          <div class="modal-header">
            <div class="modal-date">${formattedDate}</div>
            <h2 class="modal-title">${workouts.length > 1 ? 'Today\'s Workouts' : 'Today\'s Workout'}</h2>
          </div>
          <div class="modal-workout-list">
            ${workouts.map((workout, index) => {
              const details = parseWorkoutDetails(workout);
              const intensity = detectIntensity(workout);
              const briefSummary = getBriefSummary(workout);
              return `
                <div class="modal-workout-item">
                  <!-- Header -->
                  <div class="flex items-center gap-3 mb-5">
                    ${workouts.length > 1 ? `<span class="exercise-number" style="width: 40px; height: 40px; font-size: 18px; font-weight: 900;">${index + 1}</span>` : ''}
                    <div>
                      <h3 class="workout-name" style="font-size: 24px; margin-bottom: 8px; font-weight: 900;">${details.name}</h3>
                      ${intensity ? `<span class="workout-type-badge workout-type-${intensity}" style="font-size: 12px; padding: 5px 12px;">${intensity}</span>` : ''}
                    </div>
                  </div>
                  
                  <!-- Single Card with Stats and Instructions -->
                  <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(79, 70, 229, 0.15)); border: 2px solid rgba(236, 72, 153, 0.3); border-radius: 20px; padding: 24px;">
                    <!-- Stats in Row -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid rgba(236, 72, 153, 0.2);">
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-route" style="margin-right: 4px;"></i>Distance
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.distance || '-'}</div>
                      </div>
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-heartbeat" style="margin-right: 4px;"></i>Heart Rate
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.heartRate || '-'}</div>
                      </div>
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-tachometer-alt" style="margin-right: 4px;"></i>Pace
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.pace || '-'}</div>
                      </div>
                    </div>
                    <!-- Instructions -->
                    ${briefSummary ? `
                      <div>
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 10px; letter-spacing: 0.5px;">
                          <i class="fas fa-info-circle" style="margin-right: 4px;"></i>Instructions
                        </div>
                        <p style="color: #e2e8f0; font-size: 14px; line-height: 1.6; margin: 0; font-weight: 500;">${briefSummary}</p>
                      </div>
                    ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
      }

      function closeWorkoutModal() {
        const overlay = document.querySelector('.workout-modal-overlay');
        if (overlay) {
          overlay.style.animation = 'fadeOut 0.2s ease';
          setTimeout(() => {
            overlay.remove();
            document.body.style.overflow = '';
          }, 200);
        }
      }

      // Add fadeOut animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
      `;
      document.head.appendChild(style);

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeWorkoutModal();
        }
      });

      // New Plan button
      document.getElementById('new-plan-btn').addEventListener('click', () => {
        document.getElementById('wizard-overlay').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
        
        // Reset wizard
        currentStep = 1;
        selectedSport = null;
        document.getElementById('plan-name').value = '';
        document.getElementById('current-time').value = '';
        document.getElementById('goal-time').value = '';
        document.getElementById('additional-info').value = '';
        document.querySelectorAll('.sport-card').forEach(c => c.classList.remove('selected'));
        
        // Reset wizard UI
        document.querySelectorAll('.wizard-step').forEach(step => {
          step.classList.remove('active', 'exiting');
        });
        document.querySelector('.wizard-step[data-step="1"]').classList.add('active');
        
        updateStepUI();
        updateNavigationButtons();
        
        createBtn.innerHTML = '<span>Create My Plan</span><i class="fas fa-magic ml-2"></i>';
        createBtn.disabled = false;
      });

      // Initialize wizard on load
      initWizard();
    </script>
  </body>
</html>
