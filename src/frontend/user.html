<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Stretchletics - Dashboard</title>
  <link rel="icon" type="image/png" href="../media/logo_round.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'neon-pink': '#EC4899',
            'neon-indigo': '#4F46E5',
            'deep-black': '#050505',
            'dark-charcoal': '#10141D',
            'deep-navy': '#1D2A4A',
          },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    :root {
      font-family: 'Inter', sans-serif;
    }

    /* Floating Orb Animations */
    @keyframes float-orb {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    .bg-orb-1 {
      position: fixed;
      top: 10%;
      left: 10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(236, 72, 153, 0.3) 0%, transparent 70%);
      border-radius: 50%;
      filter: blur(60px);
      animation: float-orb 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .bg-orb-2 {
      position: fixed;
      top: 60%;
      right: 15%;
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, rgba(79, 70, 229, 0.3) 0%, transparent 70%);
      border-radius: 50%;
      filter: blur(60px);
      animation: float-orb 20s ease-in-out infinite 5s;
      pointer-events: none;
      z-index: 0;
    }

    /* Card Styling */
    .option-card {
      background: rgba(10, 10, 10, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .option-card:hover {
      border-color: rgba(236, 72, 153, 0.5);
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 60px rgba(236, 72, 153, 0.3);
    }

    .gradient-button {
      background-image: linear-gradient(to right, #4F46E5 0%, #EC4899 51%, #4F46E5 100%);
      background-size: 200% auto;
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .gradient-button:hover {
      background-position: right center;
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(236, 72, 153, 0.5);
    }
  </style>
    <style>
      /* Modal for plan preview */
      .plan-preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 60; }
      .plan-preview-overlay.open { display: flex; }
      .plan-preview { width: 95%; max-width: 900px; background: rgba(10,10,10,0.95); border-radius: 12px; padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.06); color: #e6eef8; }
      .plan-preview-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
      .plan-preview-title { font-weight:800; font-size:1.1rem; }
      .plan-preview-close { background: transparent; border: none; color: #cbd5e1; font-size: 1rem; cursor:pointer; }
      /* Simple calendar preview grid */
      .preview-calendar-grid { display:flex; flex-direction:column; gap:8px; }
      .preview-weekdays { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:6px; }
      .preview-weekday { font-weight:700; font-size:12px; color:#94a3b8; text-align:center; }
      .preview-week { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
      .preview-day { background: rgba(255,255,255,0.02); border-radius:8px; padding:8px; min-height:70px; display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
      .preview-day.has-workout { border: 1px solid rgba(79,70,229,0.25); box-shadow: 0 6px 20px rgba(79,70,229,0.06); }
      .preview-day-num { font-weight:700; font-size:14px; color:#e6eef8; }
      .preview-day-workout { font-size:12px; color:#cbd5e1; font-weight:700; }
      .preview-badge { font-size:11px; padding:3px 6px; border-radius:999px; margin-top:auto; }
      .preview-badge-recovery { background:#dbeafe; color:#1e293b; }
      .preview-badge-easy { background:#ecfccb; color:#152238; }
      .preview-badge-moderate { background:#fef3c7; color:#422006; }
      .preview-badge-hard { background:#fee2e2; color:#4c1d1d; }

      /* Calendar styles (subset from trainingplan for modal rendering) */
      .calendar-container { width:100%; }
      .calendar-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
      .calendar-nav-btn { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px; color:#e6eef8; cursor:pointer; }
      .calendar-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:8px; align-items:start; }
      .calendar-weekday { font-weight:700; font-size:12px; color:#94a3b8; text-align:center; }
      .calendar-day-cell { background: rgba(255,255,255,0.02); border-radius:8px; padding:8px; min-height:70px; display:flex; flex-direction:column; gap:6px; }
      .calendar-day-cell.other-month { opacity:0.5; }
      .calendar-day-number { font-weight:700; font-size:14px; color:#e6eef8; }
      .calendar-workout-name { font-size:12px; color:#cbd5e1; font-weight:700; }
      .workout-type-badge { font-size:11px; padding:3px 6px; border-radius:999px; margin-top:auto; }
      .workout-type-recovery { background:#dbeafe; color:#1e293b; }
      .week-summary { background: rgba(255,255,255,0.02); border-radius:8px; padding:8px; display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
      .week-summary-title { font-weight:700; }

      /* Workout modal styles (copied from trainingplan) */
      .workout-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .workout-modal {
        background: linear-gradient(135deg, rgba(16, 20, 29, 0.95), rgba(5, 5, 5, 0.95));
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 32px;
        position: relative;
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(236, 72, 153, 0.4);
      }
      @keyframes modalSlideIn {
        from { transform: translateY(20px) scale(0.98); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
      }
    </style>

<body class="bg-deep-black text-slate-300 antialiased selection:bg-pink-500/30 selection:text-white overflow-x-hidden min-h-screen flex items-center justify-center">

  <!-- Floating background orbs -->
  <div class="bg-orb-1"></div>
  <div class="bg-orb-2"></div>

  <main class="relative z-10 w-full max-w-6xl px-6 py-12">
    <!-- Header -->
    <div class="text-center mb-16">
      <div class="flex items-center justify-center mb-6">
        <img src="../media/logo_round.png" alt="Stretchletics Logo" class="h-20 w-20 rounded-full ring-4 ring-neon-pink/30" />
      </div>
      <h1 class="text-5xl md:text-6xl font-black text-white uppercase tracking-wider mb-4">
        Welcome to <span class="bg-gradient-to-r from-neon-indigo to-neon-pink bg-clip-text text-transparent">Stretchletics</span>
      </h1>
      <p class="text-xl text-slate-400 max-w-2xl mx-auto">
        Choose your path to peak performance
      </p>
    </div>

    <!-- Options Grid -->
    <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
      
      <!-- Stretching Routines Card -->
      <a href="chat.html" class="option-card rounded-3xl p-8 block group">
        <div class="flex flex-col items-center text-center h-full">
          <div class="w-24 h-24 rounded-full bg-gradient-to-br from-neon-pink to-purple-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
            <i class="fas fa-spa text-4xl text-white"></i>
          </div>
          <h2 class="text-3xl font-black text-white uppercase tracking-wider mb-4">
            Stretching Routines
          </h2>
          <p class="text-slate-400 mb-6 flex-grow">
            AI-powered personalized stretching routines tailored to your workouts and goals. Perfect for recovery and flexibility.
          </p>
          <button class="gradient-button w-full px-6 py-3 rounded-xl text-white font-bold uppercase tracking-wider">
            Start Stretching
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </a>

      <!-- Training Plans Card -->
      <a href="trainingplan.html" class="option-card rounded-3xl p-8 block group">
        <div class="flex flex-col items-center text-center h-full">
          <div class="w-24 h-24 rounded-full bg-gradient-to-br from-neon-indigo to-cyan-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
            <i class="fas fa-calendar-days text-4xl text-white"></i>
          </div>
          <h2 class="text-3xl font-black text-white uppercase tracking-wider mb-4">
            Training Plans
          </h2>
          <p class="text-slate-400 mb-6 flex-grow">
            Customized training programs for running, cycling, swimming, or triathlon. Reach your goals with structured plans.
          </p>
          <button class="gradient-button w-full px-6 py-3 rounded-xl text-white font-bold uppercase tracking-wider">
            Build Your Plan
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </a>

    </div>

    <!-- Back to Home -->
    <div class="text-center mt-12">
      <a href="index.html" class="text-slate-500 hover:text-white transition inline-flex items-center gap-2">
        <i class="fas fa-arrow-left"></i>
        Back to Home
      </a>
    </div>

    <!-- My Plans: shows user's saved plans with view/delete -->
    <div class="max-w-4xl mx-auto mt-12 p-6 bg-black/30 rounded-2xl border border-white/10">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-white">My Plans</h3>
        <div>
          <button id="refresh-plans-btn" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm">Refresh</button>
        </div>
      </div>
      <div id="my-plans-list" class="space-y-4 text-slate-300">
        <p class="text-sm text-slate-500">Loading plans…</p>
      </div>
    </div>
  </main>

  <!-- Supabase client & UI helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="./supabaseClient.js"></script>
  <script src="./supabase-ui.js"></script>
  <script src="./parser-utils.js"></script>
</script>

    <!-- Plan preview modal -->
    <div id="plan-preview-modal" class="plan-preview-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="plan-preview" role="document">
        <div class="plan-preview-header">
          <div class="plan-preview-title" id="plan-preview-title">Plan preview</div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-1 rounded bg-indigo-600 text-white text-sm" id="plan-preview-open">Open in Wizard</button>
            <button class="plan-preview-close" id="plan-preview-close" aria-label="Close preview">✕</button>
          </div>
        </div>
        <div id="plan-preview-calendar" style="max-height:60vh; overflow:auto;"></div>
      </div>
    </div>

    <script>
      // Open the preview modal and render the plan calendar (robust parsing)
      function openPlanPreview(plan) {
        const modal = document.getElementById('plan-preview-modal');
        const title = document.getElementById('plan-preview-title');
        title.textContent = plan.name || 'Training Plan';

        // keep a reference so the 'Open in Wizard' button can import it; store both raw and normalized
        window._lastPreviewedPlan = plan;

        // Robust parsing / normalization of stored content
        let parsedPlan = null;
        try {
          if (typeof plan.content === 'string') {
            // Try JSON parse first
            try {
              parsedPlan = JSON.parse(plan.content);
            } catch (e) {
              // Fallback: assume plain text plan
              parsedPlan = parsePlanText(plan.content || '');
            }
          } else if (typeof plan.content === 'object' && plan.content !== null) {
            parsedPlan = plan.content;
          } else {
            parsedPlan = parsePlanText(String(plan.content || ''));
          }
        } catch (e) {
          parsedPlan = parsePlanText(String(plan.content || ''));
        }

        // If content is a wrapper like { text: '...' }, parse the inner text
        if (parsedPlan && typeof parsedPlan === 'object' && !Array.isArray(parsedPlan) && !parsedPlan.weeks && parsedPlan.text && typeof parsedPlan.text === 'string') {
          parsedPlan = parsePlanText(parsedPlan.text);
        }

        // If someone saved just an array of weeks, wrap it
        if (Array.isArray(parsedPlan) && parsedPlan.length > 0 && !parsedPlan.weeks) {
          parsedPlan = { weeks: parsedPlan };
        }

        // If nested shape like { plan: { weeks: [...] } }, extract it
        if (parsedPlan && !parsedPlan.weeks) {
          for (const k of Object.keys(parsedPlan)) {
            if (parsedPlan[k] && parsedPlan[k].weeks && Array.isArray(parsedPlan[k].weeks)) {
              parsedPlan = parsedPlan[k];
              break;
            }
          }
        }

        // Keep normalized parsed plan for Open in Wizard
        window._lastPreviewedParsedPlan = parsedPlan;

        // Resolve start date from metadata if present
        let start = new Date();
        try {
          if (plan.start_date) start = new Date(plan.start_date);
          else if (plan.metadata && plan.metadata.plan_start) start = new Date(plan.metadata.plan_start);
          else if (plan.metadata && plan.metadata.start_date) start = new Date(plan.metadata.start_date);
        } catch (e) { start = new Date(); }

        // If parsedPlan doesn't have weeks, attempt a best-effort auto-parse from raw text, then fallback to raw UI
        if (!parsedPlan || !parsedPlan.weeks || !Array.isArray(parsedPlan.weeks) || parsedPlan.weeks.length === 0) {
          const container = document.getElementById('plan-preview-calendar');
          const raw = (typeof plan.content === 'string') ? plan.content : JSON.stringify(plan.content, null, 2);

          // Try auto-parse heuristics on raw text
          try {
            const parsedAttempt = tryAutoParseRaw(raw);
            if (parsedAttempt && parsedAttempt.weeks && parsedAttempt.weeks.length > 0) {
              window._lastPreviewedParsedPlan = parsedAttempt;
              renderFullCalendarModal(document.getElementById('plan-preview-calendar'), parsedAttempt, start);
              modal.classList.add('open');
              modal.setAttribute('aria-hidden', 'false');
              return;
            }
          } catch (e) { console.warn('Auto-parse heuristics failed', e); }

          // If heuristics didn't yield a structured plan, fall back to raw UI (user can click Try to parse).

          // Fallback UI: show raw and offer actions
          container.innerHTML = `
            <div class="p-4 text-sm text-slate-300">
              <div>No structured plan data found to preview.</div>
              <div style="margin-top:8px; color:#94a3b8;">Showing raw content below:</div>
              <pre id="plan-preview-raw" style="white-space:pre-wrap; max-height:30vh; overflow:auto; margin-top:8px; background:#0b1220; padding:12px; border-radius:8px;">${escapeHtml(raw)}</pre>
              <div class="mt-3 flex gap-2">
                <button id="try-parse-btn" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm">Try to parse & preview</button>
                <button id="open-wizard-from-raw" class="px-3 py-1 rounded bg-white/5 text-slate-300 text-sm">Open in Wizard</button>
              </div>
              <div id="parse-debug" class="mt-3 text-xs text-slate-400"></div>
            </div>
          `;

          // Bind try-parse button
          document.getElementById('try-parse-btn').addEventListener('click', () => {
            try {
              const rawText = raw;
              const parsedAttempt = parsePlanText(rawText);
              if (parsedAttempt && parsedAttempt.weeks && parsedAttempt.weeks.length > 0) {
                // Replace normalized parsed plan and open trainingplan in preview iframe
                window._lastPreviewedParsedPlan = parsedAttempt;
                try { localStorage.setItem('preview_plan', JSON.stringify(parsedAttempt)); } catch (e) { console.warn('Could not set preview_plan', e); }
                const container = document.getElementById('plan-preview-calendar');
                container.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = 'trainingplan.html?preview=true&_=' + Date.now();
                iframe.style.width = '100%'; iframe.style.height = '70vh'; iframe.style.border = '0'; iframe.style.borderRadius = '8px';
                container.appendChild(iframe);
              } else {
                const dbg = document.getElementById('parse-debug');
                dbg.textContent = 'Parsing attempted but no weeks were recognized. You can open in the wizard to edit and convert it.';
              }
            } catch (e) { document.getElementById('parse-debug').textContent = 'Parse failed: ' + (e.message || e); }
          });

          document.getElementById('open-wizard-from-raw').addEventListener('click', () => {
            try { localStorage.setItem('imported_plan', raw); } catch(e){ localStorage.setItem('imported_plan', JSON.stringify(plan.content)); }
            closePlanPreview();
            window.location.href = 'trainingplan.html';
          });

          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
          return;
        }

        // Use the exact editor page in preview mode (iframe) so the calendar is identical
        try {
          localStorage.setItem('preview_plan', JSON.stringify(parsedPlan));
        } catch (e) { console.warn('Could not store preview_plan', e); }
        const container = document.getElementById('plan-preview-calendar');
        container.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.src = 'trainingplan.html?preview=true&_=' + Date.now();
        iframe.style.width = '100%';
        iframe.style.height = '70vh';
        iframe.style.border = '0';
        iframe.style.borderRadius = '8px';
        container.appendChild(iframe);

        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        // remove preview_plan when modal is closed (cleanup handled on close)
      }

      // Small helper to escape raw content for safe HTML display
      function escapeHtml(s) {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // Attempt to auto-convert raw plan text into a structured { weeks: [...] } object using heuristics
      function tryAutoParseRaw(raw) {
        if (!raw || typeof raw !== 'string') return null;
        const text = raw.replace(/\r\n/g, '\n').replace(/\t/g, ' ').trim();

        // 1) Try the existing parser first
        try {
          const parsed = parsePlanText(text);
          if (parsed && parsed.weeks && parsed.weeks.length > 0) return parsed;
        } catch (e) { /* ignore */ }

        // 2) If the text contains explicit Week headers, split by week and parse each chunk
        if (/\bWeek\b\s*\d+/i.test(text) || /\*\*Week/i.test(text)) {
          const chunks = text.split(/(?=\*\*?Week\s*\d+|\bWeek\s*\d+)/i).filter(Boolean);
          const weeks = [];
          for (const chunk of chunks) {
            try {
              const p = parsePlanText(chunk);
              if (p && p.weeks && p.weeks.length) {
                // adopt the first week parsed from the chunk
                weeks.push(p.weeks[0]);
                continue;
              }
            } catch (e) {}

            // Fallback: try to extract days inside chunk
            const days = [];
            const dayParts = chunk.split(/(?=\*\*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)|^\s*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b)/im).filter(Boolean);
            for (const dp of dayParts) {
              const nameMatch = dp.match(/\*\*(Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s*([^\n]*)/i);
              const dayName = nameMatch ? nameMatch[0].replace(/\*\*/g,'').trim() : 'Day';
              const workouts = dp.replace(/\*\*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)[^\n]*\n?/i,'').trim();
              if (workouts) days.push({ name: dayName, workouts: [workouts] });
            }
            if (days.length) weeks.push({ number: weeks.length + 1, days });
          }
          if (weeks.length) return { weeks };
        }

        // 3) Detect day headings without weeks (Monday..Sunday or Day X). Group into weeks of up to 7 days
        if (/\b(?:Day\s*\d+|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/i.test(text)) {
          const parts = text.split(/(?=\*\*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)|^\s*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b)/im).filter(Boolean);
          const days = [];
          for (const part of parts) {
            const nameMatch = part.match(/\*\*(Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s*([^\n]*)/i);
            const dayName = nameMatch ? nameMatch[0].replace(/\*\*/g,'').trim() : 'Day';
            const workouts = part.replace(/\*\*(?:Day|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)[^\n]*\n?/i,'').trim();
            days.push({ name: dayName, workouts: workouts ? [workouts] : [] });
          }
          // Group into weeks
          const weeks = [];
          for (let i=0;i<days.length;i+=7) {
            weeks.push({ number: Math.floor(i/7)+1, days: days.slice(i, i+7) });
          }
          if (weeks.length) return { weeks };
        }

        // 4) Try to parse JSON shapes that may contain weeks nested in keys
        try {
          const js = JSON.parse(text);
          if (js) {
            if (js.weeks && Array.isArray(js.weeks) && js.weeks.length) return js;
            if (js.plan && js.plan.weeks && js.plan.weeks.length) return js.plan;
            for (const k of Object.keys(js)) {
              const v = js[k];
              if (v && v.weeks && Array.isArray(v.weeks) && v.weeks.length) return v;
              if (Array.isArray(v) && v.length && v[0] && (v[0].days || v[0].workouts)) return { weeks: v };
            }
          }
        } catch (e) { /* ignore */ }

        // No heuristics matched
        return null;
      }

      // Local workout modal for preview (used when trainingplan's showWorkoutModal is not available)
      function showWorkoutModalPreview(dateStr, workouts) {
        const date = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);

        const overlay = document.createElement('div');
        overlay.className = 'workout-modal-overlay';
        overlay.onclick = (e) => { if (e.target === overlay) closeWorkoutModalPreview(); };

        const modal = document.createElement('div');
        modal.className = 'workout-modal';
        modal.onclick = (e) => e.stopPropagation();

        const getBriefSummary = (workout) => {
          if (typeof workout === 'object' && workout !== null) {
            return workout.detail || workout.details || workout.description || '';
          }
          let summary = String(workout).replace(/\*\*/g, '').trim();
          summary = summary.replace(/\d+(?:\.\d+)?\s*(?:km|k|kilometers?|miles?|mi)(?!\s*\/)/gi, '');
          summary = summary.replace(/(?:HR|Heart\s*Rate)[:\s]*[\d\-]+\s*(?:bpm|%)?/gi, '');
          summary = summary.replace(/Zone\s*\d+/gi, '');
          summary = summary.replace(/(?:Pace|@)[:\s]*[\d:]+\s*(?:\/|per)?\s*km/gi, '');
          summary = summary.replace(/[:\•\-]+\s*/g, '').trim();
          const sentences = summary.match(/[^.!?]+[.!?]+/g);
          if (sentences && sentences.length > 0) return sentences.slice(0,2).join(' ').trim();
          return summary.substring(0,150).trim() + (summary.length > 150 ? '...' : '');
        };

        modal.innerHTML = `
          <button class="modal-close-btn" onclick="closeWorkoutModalPreview()">
            <i class="fas fa-times"></i>
          </button>
          <div class="modal-header">
            <div class="modal-date">${formattedDate}</div>
            <h2 class="modal-title">${workouts.length > 1 ? "Today's Workouts" : "Today's Workout"}</h2>
          </div>
          <div class="modal-workout-list">
            ${workouts.map((workout, index) => {
              const details = parseWorkoutDetails(workout);
              const intensity = detectIntensity(workout);
              const briefSummary = getBriefSummary(workout);
              return `
                <div class="modal-workout-item">
                  <div class="flex items-center gap-3 mb-5">
                    ${workouts.length > 1 ? `<span class="exercise-number" style="width: 40px; height: 40px; font-size: 18px; font-weight: 900;">${index + 1}</span>` : ''}
                    <div>
                      <h3 class="workout-name" style="font-size: 24px; margin-bottom: 8px; font-weight: 900;">${details.name}</h3>
                      ${intensity ? `<span class="workout-type-badge workout-type-${intensity}" style="font-size: 12px; padding: 5px 12px;">${intensity}</span>` : ''}
                    </div>
                  </div>
                  <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(79, 70, 229, 0.15)); border: 2px solid rgba(236, 72, 153, 0.3); border-radius: 20px; padding: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid rgba(236, 72, 153, 0.2);">
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-route" style="margin-right: 4px;"></i>Distance
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.distance || '-'}</div>
                      </div>
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-heartbeat" style="margin-right: 4px;"></i>Heart Rate
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.heartRate || '-'}</div>
                      </div>
                      <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px;">
                          <i class="fas fa-tachometer-alt" style="margin-right: 4px;"></i>Pace
                        </div>
                        <div style="font-size: 24px; font-weight: 900; color: #ec4899; line-height: 1;">${details.pace || '-'}</div>
                      </div>
                    </div>
                    ${briefSummary ? `<div><div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 10px; letter-spacing: 0.5px;"><i class="fas fa-info-circle" style="margin-right: 4px;"></i>Instructions</div><p style="color: #e2e8f0; font-size: 14px; line-height: 1.6; margin: 0; font-weight: 500;">${briefSummary}</p></div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
      }

      function closeWorkoutModalPreview() {
        const overlay = document.querySelector('.workout-modal-overlay');
        if (overlay) {
          overlay.style.animation = 'fadeOut 0.2s ease';
          setTimeout(() => { overlay.remove(); document.body.style.overflow = ''; }, 200);
        }
      }

      function closePlanPreview() {
        const modal = document.getElementById('plan-preview-modal');
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        try { localStorage.removeItem('preview_plan'); } catch (e) { }
        const container = document.getElementById('plan-preview-calendar');
        if (container) container.innerHTML = '';
      }

      document.getElementById('plan-preview-close').addEventListener('click', closePlanPreview);
      document.getElementById('plan-preview-modal').addEventListener('click', (e) => { if (e.target.id === 'plan-preview-modal') closePlanPreview(); });
      document.getElementById('plan-preview-open').addEventListener('click', () => {
        try {
          // Put plan content into localStorage and navigate to trainingplan
          const title = document.getElementById('plan-preview-title').textContent || 'Training Plan';
          // Extract the currently previewed plan by reading the DOM (simple approach)
          // We store the last previewed plan in window._lastPreviewedPlan when opening
          // Prefer the normalized parsed plan if available
          const parsed = window._lastPreviewedParsedPlan || (window._lastPreviewedPlan && (typeof window._lastPreviewedPlan.content === 'string' ? (function(){ try { return JSON.parse(window._lastPreviewedPlan.content); } catch(e){ return null; } })() : window._lastPreviewedPlan.content));
          if (parsed) {
            try {
              localStorage.setItem('imported_plan', JSON.stringify(parsed));
            } catch (e) { localStorage.setItem('imported_plan', JSON.stringify(window._lastPreviewedPlan.content || window._lastPreviewedPlan)); }
            closePlanPreview();
            window.location.href = 'trainingplan.html';
          } else if (window._lastPreviewedPlan) {
            // Fallback: try raw content
            try { localStorage.setItem('imported_plan', typeof window._lastPreviewedPlan.content === 'string' ? window._lastPreviewedPlan.content : JSON.stringify(window._lastPreviewedPlan.content)); }
            catch (e) { localStorage.setItem('imported_plan', JSON.stringify(window._lastPreviewedPlan)); }
            closePlanPreview();
            window.location.href = 'trainingplan.html';
          } else {
            alert('No plan is currently selected for opening.');
          }
        } catch (e) { alert('Could not open plan: ' + (e.message || e)); }
      });

      // Render a full calendar (like the wizard's end calendar) into the modal container
      function renderFullCalendarModal(container, plan, startDate) {
        container.innerHTML = '';
        if (!plan || !plan.weeks || plan.weeks.length === 0) {
          container.innerHTML = '<p class="text-sm text-slate-400">No plan data available to preview.</p>';
          return;
        }

        // Build workoutsByDate starting from provided startDate
        const workoutsByDate = {};
        let current = new Date(startDate);
        for (const week of plan.weeks) {
          for (const day of week.days) {
            const key = current.toISOString().split('T')[0];
            workoutsByDate[key] = day.workouts;
            current.setDate(current.getDate() + 1);
          }
        }

        // Local calendar state
        let modalCurrentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

        function changeMonthModal(delta) {
          modalCurrentMonth.setMonth(modalCurrentMonth.getMonth() + delta);
          updateModalCalendar();
        }
        function jumpToCurrentMonthModal() {
          const today = new Date();
          modalCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          updateModalCalendar();
        }

        function updateModalCalendar() {
          const year = modalCurrentMonth.getFullYear();
          const month = modalCurrentMonth.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const daysInMonth = lastDay.getDate();
          const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // Monday-first

          const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

          // Build header
          let html = `<div class="calendar-container">
            <div class="calendar-header">
              <button class="calendar-nav-btn" onclick="(function(){changeMonthModal(-1)})()"><i class="fas fa-chevron-left"></i> Previous</button>
              <div class="flex items-center gap-3">
                <h3 class="text-2xl font-black text-white">${monthNames[month]} ${year}</h3>
                <button class="calendar-nav-btn" onclick="(function(){jumpToCurrentMonthModal()})()"><i class="fas fa-calendar-day"></i> Today</button>
              </div>
              <div class="flex items-center gap-3">
                <button class="calendar-nav-btn" onclick="(function(){changeMonthModal(1)})()">Next <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
            <div class="calendar-grid">`;

          // Weekday headers
          const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
          html += weekdays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');
          html += '<div class="calendar-weekday">Week Summary</div>';

          // Add padding before month start
          for (let i=0;i<startingDayOfWeek;i++) html += '<div class="calendar-day-cell" style="opacity:0; pointer-events:none;"></div>';

          // Track weekly stats
          let weekNumber = 0;
          let daysInCurrentWeek = startingDayOfWeek;
          let weekDistance = 0;
          let weekDuration = 0;

          for (let dayOfMonth=1; dayOfMonth<=daysInMonth; dayOfMonth++) {
            const currentDate = new Date(year, month, dayOfMonth);
            const dateStr = currentDate.toISOString().split('T')[0];
            const workout = workoutsByDate[dateStr];

            // accumulate stats
            if (workout) {
              const stats = (typeof extractWorkoutStats === 'function') ? extractWorkoutStats(workout) : {distance:0,duration:0};
              weekDistance += stats.distance;
              weekDuration += stats.duration;
            }

            const workoutName = workout ? extractWorkoutName(workout) : '';
            const intensity = (workout && workout[0]) ? detectIntensity(workout[0]) : null;
            const displayIntensity = intensity ? (intensity.toLowerCase()==='recovery' ? 'Recovery' : intensity.charAt(0).toUpperCase()+intensity.slice(1)) : null;
            const today = new Date();
            const isToday = currentDate.getDate() === today.getDate() && currentDate.getMonth()===today.getMonth() && currentDate.getFullYear()===today.getFullYear();
            const planStart = new Date(startDate);
            const totalDays = plan.weeks.reduce((s,w)=>s+(w.days?w.days.length:0),0);
            const planEnd = new Date(startDate);
            planEnd.setDate(planEnd.getDate() + totalDays - 1);
            const isWithinPlan = currentDate >= planStart && currentDate <= planEnd;

            const workoutsJson = workout ? encodeURIComponent(JSON.stringify(workout)) : '';

            html += `
              <div class="calendar-day-cell ${workout ? 'has-workout' : ''} ${isToday ? 'today' : ''}" data-date="${dateStr}" ${workout ? `data-workouts='${workoutsJson}' style="cursor:pointer;"` : ''}>
                <div class="calendar-day-number">${dayOfMonth}</div>
                ${workout ? `
                  <div class="calendar-workout-name">${workoutName}</div>
                  ${displayIntensity ? `<div class="workout-type-badge workout-type-${intensity}" style="font-size:8px;padding:2px 6px;margin-top:4px;display:inline-block;">${displayIntensity}</div>` : ''}
                ` : (isWithinPlan ? `<div class="calendar-workout-name" style="color:#64748b;font-size:10px;font-weight:600;">Recovery</div><div class="workout-type-badge workout-type-recovery" style="font-size:8px;padding:2px 6px;margin-top:4px;display:inline-block;">Recovery</div>` : '')}
              </div>
            `;

            daysInCurrentWeek++;
            if (daysInCurrentWeek === 7) {
              weekNumber++;
              // Add week summary block
              html += `
                <div class="week-summary">
                  <div class="week-summary-title">Week ${weekNumber}</div>
                  ${weekDistance>0?`<div class="week-summary-stat"><span class="week-summary-label">Distance:</span><span class="week-summary-value">${weekDistance.toFixed(1)}km</span></div>`:''}
                  ${weekDuration>0?`<div class="week-summary-stat"><span class="week-summary-label">Duration:</span><span class="week-summary-value">${Math.round(weekDuration)}min</span></div>`:''}
                  ${weekDistance===0 && weekDuration===0?`<div class="week-summary-stat"><span class="week-summary-label">Rest Week</span></div>`:''}
                </div>
              `;
              daysInCurrentWeek = 0;
              weekDistance=0; weekDuration=0;
            }
          }

          // Fill remaining days of last week from next month
          if (daysInCurrentWeek > 0) {
            const nextMonth = month === 11 ? 0 : month + 1;
            const nextYear = month === 11 ? year + 1 : year;
            let nextDayOfMonth = 1;
            while (daysInCurrentWeek < 7) {
              const currentDate = new Date(nextYear, nextMonth, nextDayOfMonth);
              const dateStr = currentDate.toISOString().split('T')[0];
              const workout = workoutsByDate[dateStr];
              if (workout) {
                const stats = (typeof extractWorkoutStats === 'function') ? extractWorkoutStats(workout) : {distance:0,duration:0};
                weekDistance += stats.distance; weekDuration += stats.duration;
              }
              const workoutName = workout ? extractWorkoutName(workout) : '';
              const intensity = (workout && workout[0]) ? detectIntensity(workout[0]) : null;
              const displayIntensity = intensity ? (intensity.toLowerCase()==='recovery' ? 'Recovery' : intensity.charAt(0).toUpperCase()+intensity.slice(1)) : null;

              const workoutsJson = workout ? encodeURIComponent(JSON.stringify(workout)) : '';

              html += `
                <div class="calendar-day-cell ${workout ? 'has-workout' : ''} other-month" data-date="${dateStr}" ${workout ? `data-workouts='${workoutsJson}' style="cursor:pointer;"` : ''}>
                  <div class="calendar-day-number">${nextDayOfMonth}</div>
                  ${workout ? `
                    <div class="calendar-workout-name">${workoutName}</div>
                    ${displayIntensity ? `<div class="workout-type-badge workout-type-${intensity}" style="font-size:8px;padding:2px 6px;margin-top:4px;display:inline-block;">${displayIntensity}</div>` : ''}
                  ` : ( (currentDate >= new Date(startDate) && currentDate <= new Date(startDate).setDate(new Date(startDate).getDate()+ (plan.weeks.reduce((s,w)=>s+(w.days?w.days.length:0),0)-1)) ) ? `<div class="calendar-workout-name" style="color:#64748b;font-size:10px;font-weight:600;">Recovery</div><div class="workout-type-badge workout-type-recovery" style="font-size:8px;padding:2px 6px;margin-top:4px;display:inline-block;">Recovery</div>` : '')}
                </div>
              `;

              daysInCurrentWeek++; nextDayOfMonth++;
            }

            weekNumber++;
            html += `
              <div class="week-summary">
                <div class="week-summary-title">Week ${weekNumber}</div>
                ${weekDistance>0?`<div class="week-summary-stat"><span class="week-summary-label">Distance:</span><span class="week-summary-value">${weekDistance.toFixed(1)}km</span></div>`:''}
                ${weekDuration>0?`<div class="week-summary-stat"><span class="week-summary-label">Duration:</span><span class="week-summary-value">${Math.round(weekDuration)}min</span></div>`:''}
                ${weekDistance===0 && weekDuration===0?`<div class="week-summary-stat"><span class="week-summary-label">Rest Week</span></div>`:''}
              </div>
            `;
          }

          html += '</div></div>';
          container.innerHTML = html;

          // Attach click handlers for day cells with workouts
          container.querySelectorAll('.calendar-day-cell[data-workouts]').forEach(el => {
            el.addEventListener('click', () => {
              try {
                const encoded = el.getAttribute('data-workouts');
                const ws = encoded ? JSON.parse(decodeURIComponent(encoded)) : null;
                const date = el.getAttribute('data-date');
                if (ws) {
                  if (typeof showWorkoutModal === 'function') {
                    showWorkoutModal(date, ws);
                  } else {
                    showWorkoutModalPreview(date, ws);
                  }
                }
              } catch (e) {
                console.error('Failed to open workout modal', e);
              }
            });
          });
        }

        // Expose month controls for buttons
        window.changeMonthModal = changeMonthModal;
        window.jumpToCurrentMonthModal = jumpToCurrentMonthModal;

        // Initial render
        updateModalCalendar();
      }

      // Close preview on Escape
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePlanPreview(); });

    </script>

    <script>
      // Render user's saved plans into the dashboard
      async function renderMyPlans() {
        const el = document.getElementById('my-plans-list');
        if (!el) return;
        el.innerHTML = '<p class="text-sm text-slate-500">Loading plans…</p>';
        try {
          if (window.supabaseUI && typeof window.supabaseUI.ensureSupabaseConfig === 'function') {
            const ok = await window.supabaseUI.ensureSupabaseConfig();
            if (!ok) { el.innerHTML = '<p class="text-sm text-slate-500">Supabase not configured.</p>'; return; }
          }

          const res = await window.supabaseClient.loadPlans();
          if (res.error) {
            const msg = res.error.message || JSON.stringify(res.error);
            const lower = String(msg).toLowerCase();
            if (lower.includes("could not find the table") || lower.includes("relation \"plans\" does not exist") || lower.includes('no such table')) {
              el.innerHTML = `
                <div class="p-4 bg-black/20 rounded-lg border border-white/5">
                  <div class="font-bold text-white mb-2">No plans table found</div>
                  <p class="text-sm text-slate-400 mb-3">It looks like your Supabase database doesn't have the required <code>plans</code> table or the schema cache is outdated.</p>
                  <div class="flex gap-2">
                    <button id="show-migration-btn" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm">Show migration instructions</button>
                    <button id="retry-plans-btn" class="px-3 py-2 bg-white/5 text-slate-300 rounded border border-white/10 text-sm">Retry</button>
                  </div>
                </div>
              `;
              document.getElementById('show-migration-btn').addEventListener('click', () => {
                alert('Run the SQL migration located at `db/migrations/0001_create_plans_and_workouts.sql` in your Supabase SQL editor to create the `plans` table. After running the migration, click Retry.');
              });
              document.getElementById('retry-plans-btn').addEventListener('click', renderMyPlans);
              return;
            }
            el.innerHTML = `<p class="text-sm text-red-500">Error loading plans: ${msg}</p>`; return;
          }

          const plans = res.data || [];
          if (plans.length === 0) { el.innerHTML = '<p class="text-sm text-slate-500">No plans saved yet</p>'; return; }
          el.innerHTML = '';
          const savedId = localStorage.getItem('last_saved_plan_id');

          plans.forEach(plan => {
            const div = document.createElement('div');
            div.className = 'p-4 bg-black/20 rounded-lg border border-white/5 flex items-center justify-between';
            div.dataset.planId = plan.id;

            const left = document.createElement('div');
            left.innerHTML = `<div class="font-bold text-white">${plan.name}</div><div class="text-sm text-slate-400">${new Date(plan.created_at).toLocaleString()}</div>`;
            const right = document.createElement('div');
            right.className = 'flex items-center gap-2';
            const view = document.createElement('button');
            view.className = 'px-3 py-2 bg-indigo-600 text-white rounded text-sm';
            view.textContent = 'View';
            view.addEventListener('click', () => { openPlanPreview(plan); });
            const del = document.createElement('button');
            del.className = 'px-3 py-2 bg-red-600 text-white rounded text-sm';
            del.textContent = 'Delete';
            del.addEventListener('click', async () => {
              if (!confirm('Delete this plan?')) return;
              try {
                const dres = await window.supabaseClient.deletePlan(plan.id);
                if (dres.error) { alert('Delete failed: ' + (dres.error.message||JSON.stringify(dres.error))); return; }
                div.remove();
              } catch (e) { alert('Delete failed: ' + e.message); }
            });
            right.appendChild(view);
            right.appendChild(del);
            div.appendChild(left);
            div.appendChild(right);
            el.appendChild(div);

            if (savedId && String(plan.id) === String(savedId)) {
              div.style.boxShadow = '0 0 0 3px rgba(236,72,153,0.18)';
              div.scrollIntoView({behavior: 'smooth', block: 'center'});
              setTimeout(() => { div.style.boxShadow = ''; localStorage.removeItem('last_saved_plan_id'); }, 3000);
            }
          });
        } catch (e) { el.innerHTML = `<p class="text-sm text-red-500">Load failed: ${e.message}</p>`; }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const refresh = document.getElementById('refresh-plans-btn');
        if (refresh) refresh.addEventListener('click', renderMyPlans);

        (function tryRender(attempts = 25) {
          if (typeof window.supabaseClient !== 'undefined') {
            renderMyPlans();
          } else if (attempts > 0) {
            setTimeout(() => tryRender(attempts - 1), 200);
          } else {
            const el = document.getElementById('my-plans-list');
            if (el && el.innerHTML.trim() === '<p class="text-sm text-slate-500">Loading plans…</p>') {
              el.innerHTML = '<p class="text-sm text-slate-500">No plans to show yet — click Refresh after signing in.</p>';
            }
          }
        })();
      });

    </script>

</body>
</html>
